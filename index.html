<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta name="description"
        content="Marul AI, günlük işlerinizi kolaylaştıran güçlü bir yapay zekâ asistanı. Soru sorun, fikir isteyin, kod yazdırın, hesap yaptırın—Marul AI her zaman hazır!">

    <title>Marul AI - Akıllı Sohbet Asistanı</title>

    <!-- Cloudflare Turnstile Script -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.png">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Marul AI",
      "url": "https://marulai.com.tr",
      "logo": "https://marulai.com.tr/favicon.png"
    }
    </script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9887645562823181"
        crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V0TG9J2D9C"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-V0TG9J2D9C');
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-deep: #050505;
            --bg-dark: #0a0a0f;
            --bg-card: rgba(20, 20, 30, 0.6);
            --bg-sidebar: rgba(10, 12, 16, 0.7);
            --border-light: rgba(255, 255, 255, 0.08);

            --primary: #00ff9d;
            --primary-glow: rgba(0, 255, 157, 0.4);
            --secondary: #7000ff;
            --accent: #00e5ff;
            --donate-color: #ff4757;

            --text-main: #ffffff;
            --text-muted: #8b9bb4;

            --msg-user-bg: linear-gradient(135deg, rgba(112, 0, 255, 0.15), rgba(0, 229, 255, 0.15));
            --msg-user-border: rgba(112, 0, 255, 0.3);
            --msg-ai-bg: rgba(255, 255, 255, 0.03);

            --radius-xl: 24px;
            --radius-lg: 16px;
            --radius-md: 12px;

            --sidebar-w: 280px;
            --anim-fast: 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --anim-smooth: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            --shadow-card: 0 20px 50px rgba(0, 0, 0, 0.7);
        }

        [data-theme="light"] {
            --bg-deep: #f0f2f5;
            --bg-dark: #ffffff;
            --bg-card: rgba(255, 255, 255, 0.7);
            --bg-sidebar: rgba(255, 255, 255, 0.8);
            --border-light: rgba(0, 0, 0, 0.08);

            --primary: #00bf72;
            --primary-glow: rgba(0, 191, 114, 0.2);
            --secondary: #6c5ce7;

            --text-main: #2d3436;
            --text-muted: #636e72;

            --msg-user-bg: linear-gradient(135deg, #6c5ce7, #74b9ff);
            --msg-user-border: transparent;
            --msg-ai-bg: #ffffff;
            --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            background: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            height: 100vh;
            overflow: hidden;
            transition: background 0.5s ease, color 0.5s ease;
        }

        .nebula-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 10% 20%, rgba(112, 0, 255, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 255, 157, 0.05) 0%, transparent 40%);
            pointer-events: none;
            z-index: -2;
            transition: opacity 0.5s;
        }

        [data-theme="light"] .nebula-bg {
            background: radial-gradient(circle at 10% 20%, rgba(108, 92, 231, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 10%, rgba(0, 191, 114, 0.1) 0%, transparent 40%);
        }

        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.4;
            pointer-events: none;
            z-index: -1;
        }

        [data-theme="light"] .grid-overlay {
            background-image: linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
        }

        .app-wrapper {
            display: flex;
            height: 100%;
        }

        .sidebar {
            width: var(--sidebar-w);
            background: var(--bg-sidebar);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            z-index: 50;
            transition: transform var(--anim-smooth), background 0.3s;
        }

        .brand-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 2rem;
        }

        .brand-logo-img {
            width: 38px;
            height: 38px;
            filter: drop-shadow(0 0 10px var(--primary-glow));
        }

        .brand-text {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--text-main);
        }

        .btn-new-chat {
            position: relative;
            background: linear-gradient(135deg, rgba(128, 128, 128, 0.1), rgba(128, 128, 128, 0.05));
            border: 1px solid var(--border-light);
            color: var(--text-main);
            padding: 14px;
            border-radius: var(--radius-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
            overflow: hidden;
            transition: var(--anim-fast);
        }

        .btn-new-chat:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 157, 0.15);
        }

        .sidebar-scroll-area {
            flex: 1;
            overflow-y: auto;
            margin-top: 1.5rem;
            padding-right: 5px;
        }

        .history-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .history-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: var(--radius-md);
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--anim-fast);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .history-item:hover {
            background: rgba(128, 128, 128, 0.1);
            color: var(--text-main);
        }

        .history-item.active {
            background: rgba(0, 255, 157, 0.08);
            border: 1px solid var(--primary);
            color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.1) inset;
        }

        [data-theme="light"] .history-item.active {
            background: rgba(0, 191, 114, 0.1);
            border: 1px solid var(--primary);
            box-shadow: 0 0 15px rgba(0, 191, 114, 0.15) inset;
        }

        .history-date {
            font-size: 0.75rem;
            margin-top: 4px;
            color: #3498db;
            font-weight: 500;
        }

        [data-theme="dark"] .history-date {
            color: #5dade2;
        }

        .item-actions button {
            background: none;
            border: none;
            color: inherit;
            margin-left: 5px;
            cursor: pointer;
        }

        .item-actions button:hover {
            color: #ff6b6b;
        }

        .sidebar-footer {
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .donate-btn-sidebar {
            background: linear-gradient(135deg, var(--donate-color), #ff6b81);
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: var(--radius-md);
            width: 100%;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--anim-fast);
        }

        .donate-btn-sidebar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);
        }

        .sidebar-link {
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-muted);
            padding: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--anim-fast);
        }

        .sidebar-link:hover {
            color: var(--text-main);
            background: rgba(128, 128, 128, 0.05);
            border-radius: var(--radius-sm);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(128, 128, 128, 0.05);
            border-radius: var(--radius-md);
            margin-top: 5px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #fff;
            font-size: 1rem;
        }

        .user-info {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .login-btn-mini {
            background: none;
            border: none;
            color: var(--text-main);
            cursor: pointer;
            padding: 5px;
            opacity: 0.7;
        }

        .login-btn-mini:hover {
            opacity: 1;
            color: var(--primary);
        }

        .main-chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-header {
            height: 70px;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-light);
            backdrop-filter: blur(10px);
            background: rgba(var(--bg-deep), 0.7);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            overflow: hidden;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-main);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .chat-title {
            font-family: 'Space Grotesk';
            font-size: 1.1rem;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .edit-title-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
        }

        .header-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(128, 128, 128, 0.1);
            border: 1px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--anim-fast);
        }

        .header-action-btn:hover {
            background: rgba(128, 128, 128, 0.2);
            color: var(--text-main);
        }

        .theme-toggle-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border-light);
            background: rgba(128, 128, 128, 0.1);
            color: var(--text-main);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-left: 10px;
        }

        .theme-toggle-btn:hover {
            transform: rotate(15deg) scale(1.1);
            background: rgba(255, 255, 0, 0.1);
            color: #ffd700;
        }

        .messages-container {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            opacity: 0;
            animation: fadeIn 0.8s forwards;
        }

        .welcome-logo {
            width: 80px;
            height: 80px;
            position: relative;
            z-index: 2;
            border-radius: 20px;
        }

        .welcome-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, var(--primary-glow) 0%, transparent 70%);
            filter: blur(20px);
            z-index: 1;
            animation: pulse 3s infinite;
        }

        .message {
            display: flex;
            gap: 15px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            animation: slideUp 0.3s forwards;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            background: #222;
            border: 1px solid var(--border-light);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message.user .message-avatar {
            background: #333;
            color: #fff;
        }

        .message-content {
            padding: 1rem 1.2rem;
            border-radius: var(--radius-lg);
            line-height: 1.6;
            font-size: 0.95rem;
            position: relative;
            background: var(--msg-ai-bg);
            border: 1px solid var(--border-light);
            color: var(--text-main);
        }

        .message.user .message-content {
            background: var(--msg-user-bg);
            border: 1px solid var(--msg-user-border);
            color: #fff;
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 5px;
            text-align: right;
        }

        .input-area {
            padding: 1.5rem 2rem;
            background: linear-gradient(to top, var(--bg-deep) 40%, transparent);
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        .api-disclaimer {
            text-align: center;
            font-size: 0.75rem;
            color: #ffae00;
            margin-bottom: 10px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .input-wrapper {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 24px;
            padding: 8px 16px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.2);
            transition: var(--anim-fast);
        }

        .input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.1);
        }

        textarea {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-main);
            padding: 12px 0;
            resize: none;
            max-height: 200px;
            font-family: inherit;
            font-size: 1rem;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: none;
            background: var(--primary);
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--anim-fast);
            margin-bottom: 4px;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--primary);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-main);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            animation: slideInRight 0.3s forwards;
            backdrop-filter: blur(10px);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--anim-fast);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-card {
            background: var(--bg-dark);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: 0;
            width: 90%;
            max-width: 800px;
            position: relative;
            transform: scale(0.95);
            transition: var(--anim-smooth);
            box-shadow: var(--shadow-card);
            display: flex;
            overflow: hidden;
        }

        .modal-card.small {
            max-width: 400px;
            padding: 2rem;
            display: block;
        }

        .modal-overlay.active .modal-card {
            transform: scale(1);
        }

        .modal-sidebar {
            width: 200px;
            background: rgba(128, 128, 128, 0.05);
            border-right: 1px solid var(--border-light);
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-tab {
            width: 100%;
            text-align: left;
            padding: 12px 15px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: var(--text-muted);
            font-weight: 500;
            cursor: pointer;
            transition: var(--anim-fast);
            font-family: 'Outfit', sans-serif;
        }

        .info-tab:hover {
            background: rgba(128, 128, 128, 0.1);
            color: var(--text-main);
        }

        .info-tab.active {
            background: rgba(0, 255, 157, 0.1);
            color: var(--primary);
            font-weight: 700;
        }

        [data-theme="light"] .info-tab.active {
            background: rgba(0, 191, 114, 0.15);
        }

        .modal-body {
            flex: 1;
            padding: 2.5rem;
            overflow-y: auto;
            max-height: 60vh;
            color: var(--text-main);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 10;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(128, 128, 128, 0.1);
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--anim-fast);
        }

        .modal-close:hover {
            background: #ff4757;
            color: #fff;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(128, 128, 128, 0.05);
            padding: 5px;
            border-radius: 12px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .auth-tab.active {
            background: var(--primary);
            color: #000;
            box-shadow: 0 4px 10px rgba(0, 255, 157, 0.3);
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            background: rgba(128, 128, 128, 0.05);
            border: 1px solid var(--border-light);
            border-radius: 10px;
            color: var(--text-main);
        }

        .primary-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border: none;
            border-radius: 12px;
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            position: relative;
        }

        .primary-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        [data-theme="light"] .primary-btn {
            color: #fff;
        }

        .social-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(128, 128, 128, 0.05);
            border-radius: 12px;
            margin-bottom: 10px;
            color: var(--text-main);
            text-decoration: none;
            transition: 0.2s;
        }

        .social-item:hover {
            background: rgba(0, 255, 157, 0.1);
            color: var(--primary);
            transform: translateX(5px);
        }

        /* Turnstile Widget Container */
        .turnstile-container {
            margin: 15px 0;
            min-height: 65px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            background: rgba(128, 128, 128, 0.05);
        }

        .turnstile-error {
            color: #ff4757;
            font-size: 0.8rem;
            margin-top: 5px;
            text-align: center;
        }

        .turnstile-loading {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -100%;
                height: 100%;
                width: 85%;
            }

            .sidebar.open {
                left: 0;
            }

            .mobile-menu-btn {
                display: block;
            }

            .modal-card {
                flex-direction: column;
                overflow-y: auto;
                max-height: 90vh;
            }

            .modal-sidebar {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
                padding: 10px;
                border-bottom: 1px solid var(--border-light);
            }

            .info-tab {
                white-space: nowrap;
                text-align: center;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="nebula-bg"></div>
    <div class="grid-overlay"></div>

    <div class="app-wrapper">
        <nav class="sidebar" id="sidebar">
            <div class="brand-section">
                <img src="favicon.png" alt="Marul AI" class="brand-logo-img">
                <span class="brand-text" style="font-family:'Space Grotesk'; font-size: 1.5rem; font-weight: 700;">Marul
                    AI</span>
            </div>
            <button class="btn-new-chat" id="newChatBtn">
                <i class="fas fa-plus"></i> <span>Yeni Sohbet</span>
            </button>
            <div class="sidebar-scroll-area">
                <div class="history-label">GEÇMİŞ</div>
                <div class="history-container" id="chatHistoryList"></div>
            </div>
            <div class="sidebar-footer">
                <button class="donate-btn-sidebar" id="donateBtn">
                    <i class="fas fa-heart"></i> Bağış Yap
                </button>
                <button class="sidebar-link" id="infoBtn">
                    <i class="fas fa-info-circle"></i> <span>Hakkında & İletişim</span>
                </button>
                <div class="user-profile">
                    <div class="avatar" id="userAvatar">M</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Misafir</div>
                        <div class="user-status" id="questionCountDisplay">10/10 Hak</div>
                    </div>
                    <button id="authSidebarBtn" class="login-btn-mini"><i class="fas fa-sign-in-alt"></i></button>
                    <button id="logoutBtn" class="login-btn-mini" style="display: none;"><i
                            class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </nav>

        <main class="main-chat-area">
            <header class="chat-header">
                <div class="header-left">
                    <button class="mobile-menu-btn" id="sidebarToggle"><i class="fas fa-bars"></i></button>
                    <h1 class="chat-title" id="currentChatTitle">Yeni Sohbet</h1>
                    <button id="editChatTitleBtn" class="edit-title-btn"><i class="fas fa-pen"></i></button>
                </div>
                <div class="header-right" style="display: flex; align-items: center;">
                    <button class="header-action-btn" id="shareChatBtn"><i class="fas fa-share-alt"></i></button>
                    <button class="header-action-btn delete" id="clearHistoryBtn"><i
                            class="fas fa-trash-alt"></i></button>
                    <button class="theme-toggle-btn" id="themeToggleBtn" title="Temayı Değiştir">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </header>

            <div class="messages-container" id="messagesContainer">
                <div id="welcomeMessage" class="welcome-screen">
                    <div class="welcome-logo-wrapper">
                        <img src="favicon.png" alt="Marul AI" class="welcome-logo">
                        <div class="welcome-glow"></div>
                    </div>
                    <h2>Merhaba, Ben Marul AI</h2>
                    <p>Sizlere yardımcı olmak için buradayım. Kod yazabilir, analiz yapabilir veya sohbet edebiliriz.
                    </p>
                </div>
            </div>

            <div id="typingIndicator"
                style="display:none; padding: 20px 40px; color: var(--primary); font-size: 0.9rem;">
                <i class="fas fa-circle-notch fa-spin"></i> Marul AI düşünüyor...
            </div>

            <div class="input-area">
                <div class="api-disclaimer"><i class="fas fa-robot"></i> Kendi dil modelimiz geliştirilmesi bitene kadar
                    API kullanılmaktadır.</div>
                <div class="input-wrapper">
                    <textarea id="messageInput" rows="1" placeholder="Bir şeyler yaz..."></textarea>
                    <button class="send-btn" id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-card" id="infoModal" style="display: none;">
            <button class="modal-close" id="closeInfoModal"><i class="fas fa-times"></i></button>
            <div class="modal-sidebar">
                <button class="info-tab active" data-tab="about">Hakkında</button>
                <button class="info-tab" data-tab="contact">İletişim</button>
                <button class="info-tab" data-tab="terms">Kullanım Şartları</button>
                <button class="info-tab" data-tab="privacy">Gizlilik</button>
            </div>
            <div class="modal-body">
                <div id="aboutContent" class="info-content" style="display:block;">
                    <h3 style="color:var(--primary); margin-bottom:15px; font-family:'Space Grotesk';">Marul AI Hakkında
                    </h3>
                    <p>Marul AI, 2024 yılında Ahmet Karakuş tarafından geliştirilmeye başlanmıştır. Amacımız, yapay zeka
                        teknolojilerini herkes için erişilebilir, etkileşimli ve kullanıcı dostu hale getirmektir.</p>
                    <p>Yerli bir yapay zeka girişimi olarak, dil modelimizi sürekli geliştiriyor ve kullanıcı deneyimine
                        odaklanıyoruz.</p>
                    <p>Sunduğumuz hizmetler deneysel nitelikte olup, verilen bilgilerin doğruluğu garanti
                        edilmemektedir. Kullanıcıların önemli kararlar almadan önce birden fazla kaynaktan doğrulama
                        yapmaları önerilir.</p>
                </div>
                <div id="contactContent" class="info-content" style="display:none;">
                    <h3 style="color:var(--primary); margin-bottom:15px; font-family:'Space Grotesk';">İletişim</h3>
                    <p style="margin-bottom:20px; color:var(--text-muted);">Bizimle iletişime geçmek için aşağıdaki
                        kanalları kullanabilirsiniz:</p>
                    <a href="https://instagram.com/marulai_resmi" target="_blank" class="social-item"><i
                            class="fab fa-instagram"></i> Instagram (@marulai_resmi)</a>
                    <a href="https://twitter.com/MarulAI_Resmi" target="_blank" class="social-item"><i
                            class="fab fa-twitter"></i> Twitter / X (@MarulAI_Resmi)</a>
                    <a href="mailto:iletisim@marulai.com" class="social-item"><i class="fas fa-envelope"></i>
                        marulgpt@gmail.com</a>
                </div>
                <div id="termsContent" class="info-content" style="display:none;">
                    <h3 style="color:var(--primary); margin-bottom:15px; font-family:'Space Grotesk';">Kullanım Şartları
                    </h3>
                    <p>Marul AI hizmetini kullanarak aşağıdaki şartları kabul etmiş olursunuz:</p>
                    <ul style="padding-left:20px; line-height:1.6; color:rgba(255,255,255,0.8);">
                        <li>Hizmet "olduğu gibi" sunulmaktadır ve kesintisiz olacağı garanti edilmez.</li>
                        <li>Sistem üzerinden yasa dışı, zararlı veya etik dışı içerik oluşturmak yasaktır.</li>
                        <li>Hesap güvenliğinizden ve şifrenizden tamamen siz sorumlusunuz.</li>
                        <li>Marul AI, hizmeti dilediği zaman değiştirme veya sonlandırma hakkını saklı tutar.</li>
                    </ul>
                </div>
                <div id="privacyContent" class="info-content" style="display:none;">
                    <h3 style="color:var(--primary); margin-bottom:15px; font-family:'Space Grotesk';">Gizlilik
                        Politikası</h3>
                    <p>Verilerinizin gizliliği bizim için önemlidir:</p>
                    <ul style="padding-left:20px; line-height:1.6; color:rgba(255,255,255,0.8);">
                        <li>Sohbet verileriniz anonimleştirilerek sistem iyileştirmesi için kullanılabilir.</li>
                        <li>Kişisel verileriniz (e-posta vb.) üçüncü taraflarla paylaşılmaz.</li>
                        <li>Çerezler (cookies) kullanıcı deneyimini iyileştirmek için kullanılır.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="modal-card small" id="authModal" style="display: none;">
            <button class="modal-close" id="closeAuthModal"><i class="fas fa-times"></i></button>
            <div style="text-align: center; margin-bottom: 2rem;">
                <img src="favicon.png" width="50" style="margin-bottom:10px;">
                <h3>Giriş Yap</h3>
            </div>
            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab">Giriş</button>
                <button class="auth-tab" id="registerTab">Kayıt</button>
            </div>
            
            <!-- Turnstile Widget Container -->
            <div id="turnstileContainer" class="turnstile-container">
                <div class="turnstile-loading">Güvenlik doğrulaması yükleniyor...</div>
            </div>
            <div id="turnstileError" class="turnstile-error" style="display: none;"></div>
            
            <form id="loginForm">
                <input type="email" id="loginEmail" class="form-input" placeholder="E-posta" required>
                <input type="password" id="loginPassword" class="form-input" placeholder="Şifre" required>
                <button type="submit" class="primary-btn" id="loginSubmitBtn" disabled>
                    <span id="loginBtnText">Giriş Yap</span>
                </button>
            </form>
            <form id="registerForm" style="display:none;">
                <input type="text" id="registerName" class="form-input" placeholder="Ad Soyad" required>
                <input type="email" id="registerEmail" class="form-input" placeholder="E-posta" required>
                <input type="password" id="registerPassword" class="form-input" placeholder="Şifre" required>
                <input type="password" id="registerPasswordConfirm" class="form-input" placeholder="Şifre Tekrar"
                    required>
                <button type="submit" class="primary-btn" id="registerSubmitBtn" disabled>
                    <span id="registerBtnText">Kayıt Ol</span>
                </button>
            </form>
        </div>

        <div class="modal-card small" id="limitWarningModal" style="display: none; text-align:Center;">
            <div style="font-size: 3rem; color: #ffae00; margin-bottom: 20px;"><i
                    class="fas fa-exclamation-triangle"></i></div>
            <h3>Soru Hakkı Bitti</h3>
            <p style="color:var(--text-muted); margin-bottom: 20px;">Devam etmek için giriş yapmalısınız.</p>
            <button class="primary-btn" id="limitAuthBtn">Giriş Yap</button>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const CONFIG = {
            BACKEND_URL: 'https://marulgpt-backend.marulgpt.workers.dev',
            MAX_GUEST_QUESTIONS: 10,
            // TURNSTILE SITE KEY - BU DEĞERİ KENDİ TURNSTILE SITE KEY'İNİZLE DEĞİŞTİRİN
            TURNSTILE_SITE_KEY: '0x4AAAAAACIwky-WL9EDj91G' // Örnek key, kendi key'inizi ekleyin
        };

        // State Management
        const state = {
            isAuthenticated: false,
            isGuest: true,
            currentUser: null,
            sessionToken: null,
            userId: null,
            guestQuestionCount: CONFIG.MAX_GUEST_QUESTIONS,
            maxGuestQuestions: CONFIG.MAX_GUEST_QUESTIONS,
            chats: [],
            guestChats: [],
            currentChatId: null,
            userName: 'Misafir Kullanıcı',
            theme: localStorage.getItem('theme') || 'dark',
            turnstileToken: null,
            turnstileWidgetId: null,
            isTurnstileLoaded: false
        };

        // Element Cache
        const elements = {};

        // Utility Functions
        function escapeHTML(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validatePassword(password) {
            return password && password.length >= 8;
        }

        function validateName(name) {
            return name && name.trim().length >= 2;
        }

        function getSafeErrorMessage(error) {
            if (!error) return 'Bir hata oluştu. Lütfen daha sonra tekrar deneyin.';
            
            const errorStr = String(error).toLowerCase();
            
            if (errorStr.includes('password') || errorStr.includes('şifre')) {
                return 'Geçersiz kimlik bilgileri.';
            }
            if (errorStr.includes('email') || errorStr.includes('e-posta')) {
                return 'Geçersiz e-posta adresi.';
            }
            if (errorStr.includes('token') || errorStr.includes('session')) {
                return 'Oturum süreniz doldu. Lütfen tekrar giriş yapın.';
            }
            if (errorStr.includes('network') || errorStr.includes('connection')) {
                return 'Bağlantı hatası. Lütfen internet bağlantınızı kontrol edin.';
            }
            if (errorStr.includes('turnstile') || errorStr.includes('human')) {
                return 'Güvenlik doğrulaması başarısız. Lütfen tekrar deneyin.';
            }
            
            return error.length > 100 ? 'Bir hata oluştu. Lütfen daha sonra tekrar deneyin.' : error;
        }

        function showNotification(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = 'notification';
            div.style.borderColor = type === 'error' ? '#ff4757' : (type === 'success' ? '#00ff9d' : 'var(--border-light)');
            div.innerHTML = `<i class="fas fa-${type === 'error' ? 'times-circle' : (type === 'success' ? 'check-circle' : 'info-circle')}"></i> ${escapeHTML(msg)}`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // TURNSTILE FUNCTIONS
        function loadTurnstileWidget() {
            if (!window.turnstile) {
                console.error('Turnstile script not loaded');
                return;
            }
            
            const container = document.getElementById('turnstileContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Reset token
            state.turnstileToken = null;
            
            // Render Turnstile widget
            state.turnstileWidgetId = window.turnstile.render('#turnstileContainer', {
                sitekey: CONFIG.TURNSTILE_SITE_KEY,
                callback: function(token) {
                    state.turnstileToken = token;
                    updateAuthButtons();
                    document.getElementById('turnstileError').style.display = 'none';
                },
                'error-callback': function() {
                    showTurnstileError('Güvenlik doğrulaması yüklenirken bir hata oluştu.');
                    updateAuthButtons();
                },
                'expired-callback': function() {
                    state.turnstileToken = null;
                    updateAuthButtons();
                    showTurnstileError('Güvenlik doğrulaması süresi doldu. Lütfen tekrar deneyin.');
                }
            });
            
            state.isTurnstileLoaded = true;
        }

        function resetTurnstile() {
            if (state.turnstileWidgetId && window.turnstile) {
                window.turnstile.reset(state.turnstileWidgetId);
                state.turnstileToken = null;
                updateAuthButtons();
            }
        }

        function showTurnstileError(message) {
            const errorElement = document.getElementById('turnstileError');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function hideTurnstileError() {
            document.getElementById('turnstileError').style.display = 'none';
        }

        function updateAuthButtons() {
            const hasToken = !!state.turnstileToken;
            
            document.getElementById('loginSubmitBtn').disabled = !hasToken;
            document.getElementById('registerSubmitBtn').disabled = !hasToken;
        }

        // App Initialization
        document.addEventListener('DOMContentLoaded', () => {
            cacheElements();
            initTheme();
            initApp();
            setupEventListeners();
            
            // Wait for Turnstile to load
            if (window.turnstile) {
                state.isTurnstileLoaded = true;
            } else {
                // Fallback in case script doesn't load
                setTimeout(() => {
                    if (!window.turnstile) {
                        console.warn('Turnstile failed to load, using fallback');
                        state.isTurnstileLoaded = true;
                        const container = document.getElementById('turnstileContainer');
                        if (container) {
                            container.innerHTML = '<div style="color: var(--text-muted);">Güvenlik doğrulaması kullanılamıyor. Lütfen sayfayı yenileyin.</div>';
                        }
                    }
                }, 5000);
            }
        });

        function cacheElements() {
            const ids = [
                'loginTab', 'registerTab', 'loginForm', 'registerForm', 'sidebarToggle',
                'sidebar', 'newChatBtn', 'chatHistoryList', 'messagesContainer',
                'messageInput', 'sendMessageBtn', 'currentChatTitle', 'userAvatar',
                'userName', 'modalOverlay', 'authModal', 'limitWarningModal', 'infoModal',
                'logoutBtn', 'questionCountDisplay', 'infoBtn',
                'loginEmail', 'loginPassword', 'registerName', 'registerEmail', 'registerPassword', 'registerPasswordConfirm',
                'editChatTitleBtn', 'shareChatBtn', 'clearHistoryBtn',
                'authSidebarBtn', 'closeAuthModal', 'limitAuthBtn', 'closeInfoModal',
                'welcomeMessage', 'donateBtn', 'themeToggleBtn',
                'turnstileContainer', 'turnstileError', 'loginSubmitBtn', 'registerSubmitBtn'
            ];
            ids.forEach(id => elements[id] = document.getElementById(id));
        }

        function initTheme() { 
            setTheme(state.theme); 
        }
        
        function toggleTheme() { 
            setTheme(state.theme === 'dark' ? 'light' : 'dark'); 
        }
        
        function setTheme(theme) {
            state.theme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            elements.themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
        }

        async function initApp() {
            const token = localStorage.getItem('marulgpt_token');
            const userData = localStorage.getItem('marulgpt_user_data');
            const savedGuestQuestions = localStorage.getItem('marulgpt_guest_questions');
            
            if (savedGuestQuestions) state.guestQuestionCount = parseInt(savedGuestQuestions);
            
            if (token && userData) {
                await verifySession(token);
            } else {
                setupGuestMode();
            }
        }

        async function verifySession(token) {
            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}/verify-session`, { 
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    } 
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.valid && data.user) {
                        loginUser(data.user, token);
                    } else {
                        logoutUser(false);
                    }
                } else {
                    logoutUser(false);
                }
            } catch (e) { 
                setupGuestMode(); 
            }
        }

        function setupGuestMode() {
            state.isGuest = true;
            state.isAuthenticated = false;
            state.userName = 'Misafir Kullanıcı';
            
            const savedChats = localStorage.getItem('marulgpt_guest_chats');
            if (savedChats) { 
                try { 
                    state.guestChats = JSON.parse(savedChats); 
                } catch (e) { 
                    console.error('Failed to parse guest chats:', e);
                } 
            }
            
            if (state.guestChats.length === 0) {
                createNewGuestChat();
            } else if (!state.currentChatId) {
                openChat(state.guestChats[0].id);
            }
            
            renderChatHistory();
            updateUI();
        }

        function loginUser(user, token) {
            state.isAuthenticated = true;
            state.isGuest = false;
            state.currentUser = user;
            state.userName = user.name;
            state.sessionToken = token;
            state.userId = user.id;

            localStorage.setItem('marulgpt_token', token);
            localStorage.setItem('marulgpt_user_id', user.id);
            localStorage.setItem('marulgpt_user_data', JSON.stringify(user));

            updateUI();
            closeAllModals();

            elements.messagesContainer.innerHTML = '';
            loadChatHistory().then(() => {
                if (state.chats.length > 0) {
                    openChat(state.chats[0].id);
                } else {
                    createNewChat();
                }
            });
        }

        function logoutUser(confirmUser = true) {
            if (confirmUser && !confirm("Çıkış yapmak istediğinize emin misiniz?")) return;
            
            localStorage.removeItem('marulgpt_token');
            localStorage.removeItem('marulgpt_user_id');
            localStorage.removeItem('marulgpt_user_data');
            localStorage.removeItem('marulgpt_guest_questions');
            localStorage.removeItem('marulgpt_guest_chats');
            
            location.reload();
        }

        function updateUI() {
            elements.userName.textContent = escapeHTML(state.userName);
            elements.userAvatar.innerHTML = state.isAuthenticated ? escapeHTML(state.userName.charAt(0).toUpperCase()) : 'M';
            elements.userAvatar.style.background = state.isAuthenticated ? '#00ff9d' : '#ff9f43';
            elements.userAvatar.style.color = state.isAuthenticated ? '#000' : '#fff';
            
            if (state.isGuest) {
                elements.questionCountDisplay.textContent = `${state.guestQuestionCount}/${state.maxGuestQuestions} Hak`;
                elements.questionCountDisplay.style.color = '#ff9f43';
                elements.logoutBtn.style.display = 'none';
                elements.authSidebarBtn.style.display = 'block';
            } else {
                elements.questionCountDisplay.textContent = 'Üye';
                elements.questionCountDisplay.style.color = '#00ff9d';
                elements.logoutBtn.style.display = 'block';
                elements.authSidebarBtn.style.display = 'none';
            }
        }

        // Message Handling
        async function sendMessage() {
            const text = elements.messageInput.value.trim();
            if (!text) return;

            if (state.isGuest && state.guestQuestionCount <= 0) {
                openModal('limitWarningModal');
                return;
            }

            addMessageToUI('user', text);
            elements.messageInput.value = '';

            if (state.isGuest) {
                await handleGuestMessage(text);
            } else {
                await handleUserMessage(text);
            }
        }

        async function handleGuestMessage(text) {
            state.guestQuestionCount--;
            localStorage.setItem('marulgpt_guest_questions', state.guestQuestionCount);
            updateUI();
            
            const chat = getChatById(state.currentChatId);
            if (!chat) return;

            chat.messages.push({ role: 'user', content: text, timestamp: new Date() });

            if (chat.title === 'Yeni Sohbet') {
                chat.title = text.substring(0, 30);
                elements.currentChatTitle.textContent = escapeHTML(chat.title);
            }
            
            chat.updated_at = new Date();
            saveGuestChats();
            renderChatHistory();
            showTyping();
            
            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}/guest-chat`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                
                hideTyping();
                
                if (response.ok) {
                    const data = await response.json();
                    addMessageToUI('ai', data.response, true);
                    chat.messages.push({ role: 'ai', content: data.response, timestamp: new Date() });
                    saveGuestChats();
                } else {
                    const errorData = await response.json();
                    addMessageToUI('ai', 'Üzgünüm, bir hata oluştu. Lütfen daha sonra tekrar deneyin.');
                    showNotification(getSafeErrorMessage(errorData.error), 'error');
                }
            } catch (e) { 
                hideTyping(); 
                addMessageToUI('ai', 'Bağlantı hatası. Lütfen internet bağlantınızı kontrol edin.');
                showNotification(getSafeErrorMessage(e), 'error');
            }
        }

        async function handleUserMessage(text) {
            showTyping();

            const chat = getChatById(state.currentChatId);
            if (chat && chat.title === 'Yeni Sohbet') {
                chat.title = text.substring(0, 30);
                elements.currentChatTitle.textContent = escapeHTML(chat.title);
                renderChatHistory();
                
                try {
                    await fetch(`${CONFIG.BACKEND_URL}/chats/${state.currentChatId}`, { 
                        method: 'PUT', 
                        headers: { 
                            'Authorization': `Bearer ${state.sessionToken}`, 
                            'Content-Type': 'application/json' 
                        }, 
                        body: JSON.stringify({ title: chat.title }) 
                    });
                } catch (e) {
                    console.error('Başlık güncelleme hatası:', e);
                }
            }

            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}/chat`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${state.sessionToken}` 
                    },
                    body: JSON.stringify({ chatId: state.currentChatId, message: text })
                });
                
                hideTyping();
                
                if (response.ok) {
                    const data = await response.json();
                    addMessageToUI('ai', data.response, true);
                    
                    if (data.chatId && data.chatId !== state.currentChatId) {
                        state.currentChatId = data.chatId;
                        loadChatHistory();
                    }
                } else {
                    const errorData = await response.json();
                    addMessageToUI('ai', 'Üzgünüm, bir hata oluştu. Lütfen daha sonra tekrar deneyin.');
                    showNotification(getSafeErrorMessage(errorData.error), 'error');
                }
            } catch (e) { 
                hideTyping(); 
                addMessageToUI('ai', 'Bağlantı hatası. Lütfen internet bağlantınızı kontrol edin.');
                showNotification(getSafeErrorMessage(e), 'error');
            }
        }

        function addMessageToUI(role, text, animate = false, timestamp = null) {
            elements.welcomeMessage.style.display = 'none';
            const safeText = escapeHTML(text).replace(/\n/g, '<br>');
            const time = new Date(timestamp || new Date()).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            const div = document.createElement('div');
            div.className = `message ${role}`;
            
            let avatarHTML = '';
            if (role === 'ai') {
                avatarHTML = `<div class="message-avatar"><img src="favicon.png" alt="Marul AI"></div>`;
                div.innerHTML = `${avatarHTML}<div class="message-content">${safeText} <div class="message-time">${time}</div></div>`;
            } else {
                const userInitial = state.isAuthenticated ? state.userName.charAt(0).toUpperCase() : 'M';
                avatarHTML = `<div class="message-avatar" style="background:${state.isAuthenticated ? '#00ff9d' : '#ff9f43'}; color:#000;">${escapeHTML(userInitial)}</div>`;
                div.innerHTML = `<div class="message-content">${safeText} <div class="message-time">${time}</div></div>${avatarHTML}`;
            }
            
            elements.messagesContainer.appendChild(div);
            setTimeout(() => elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight, 10);
        }

        // Chat Management
        function renderChatHistory() {
            const list = state.isGuest ? state.guestChats : state.chats;
            list.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
            elements.chatHistoryList.innerHTML = '';
            
            list.forEach(chat => {
                const div = document.createElement('div');
                div.className = `history-item ${chat.id === state.currentChatId ? 'active' : ''}`;

                const date = new Date(chat.updated_at);
                const dateStr = date.toLocaleString('tr-TR', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(',', '');

                div.innerHTML = `
                    <div style="flex:1;overflow:hidden;">
                        <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                            ${escapeHTML(chat.title || 'Yeni Sohbet')}
                        </div>
                        <div class="history-date">${escapeHTML(dateStr)}</div>
                    </div>
                    <div class="item-actions">
                        <button onclick="deleteChat('${escapeHTML(chat.id)}', event)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                div.onclick = (e) => { 
                    if (!e.target.closest('button')) openChat(chat.id); 
                };
                
                elements.chatHistoryList.appendChild(div);
            });
        }

        function createNewGuestChat() {
            const newChat = { 
                id: 'guest_' + Date.now(), 
                title: 'Yeni Sohbet', 
                messages: [], 
                created_at: new Date(), 
                updated_at: new Date() 
            };
            state.guestChats.unshift(newChat); 
            saveGuestChats(); 
            openChat(newChat.id);
        }
        
        async function createNewChat() {
            if (state.isGuest) return createNewGuestChat();
            
            try {
                const res = await fetch(`${CONFIG.BACKEND_URL}/chats`, { 
                    method: 'POST', 
                    headers: { 
                        'Authorization': `Bearer ${state.sessionToken}`, 
                        'Content-Type': 'application/json' 
                    }, 
                    body: JSON.stringify({ title: 'Yeni Sohbet' }) 
                });
                
                if (res.ok) { 
                    await loadChatHistory();
                    if (state.chats.length > 0) openChat(state.chats[0].id);
                } else {
                    const errorData = await res.json();
                    showNotification(getSafeErrorMessage(errorData.error), 'error');
                }
            } catch (e) { 
                showNotification(getSafeErrorMessage(e), 'error');
            }
        }

        function openChat(chatId) {
            state.currentChatId = chatId;
            elements.messagesContainer.innerHTML = '';
            
            const chat = getChatById(chatId);
            if (chat) {
                elements.currentChatTitle.textContent = escapeHTML(chat.title || 'Yeni Sohbet');
                
                if (state.isGuest) {
                    if (chat.messages && chat.messages.length) {
                        chat.messages.forEach(m => addMessageToUI(m.role, m.content, false, m.created_at));
                    } else {
                        elements.welcomeMessage.style.display = 'flex';
                    }
                } else {
                    fetchChatMessages(chatId);
                    return;
                }
            } else {
                elements.welcomeMessage.style.display = 'flex';
            }
            
            renderChatHistory();
            
            if (window.innerWidth <= 768) {
                elements.sidebar.classList.remove('open');
            }
            
            elements.messagesContainer.appendChild(elements.welcomeMessage);
        }

        async function fetchChatMessages(chatId) {
            try {
                const res = await fetch(`${CONFIG.BACKEND_URL}/chats/${chatId}/messages`, { 
                    headers: { 
                        'Authorization': `Bearer ${state.sessionToken}`,
                        'Content-Type': 'application/json'
                    } 
                });
                
                if (res.ok) {
                    const msgs = await res.json();
                    elements.messagesContainer.innerHTML = '';
                    
                    if (msgs.length > 0) {
                        elements.welcomeMessage.style.display = 'none';
                        msgs.forEach(m => addMessageToUI(m.role === 'user' ? 'user' : 'ai', m.content, false, m.created_at));
                    } else {
                        elements.welcomeMessage.style.display = 'flex';
                        elements.messagesContainer.appendChild(elements.welcomeMessage);
                    }
                }
            } catch (e) { 
                showNotification(getSafeErrorMessage(e), 'error');
            }
        }

        function deleteChat(id, e) {
            if (e) e.stopPropagation();
            if (!confirm('Sohbeti silmek istediğinize emin misiniz?')) return;
            
            if (state.isGuest) {
                state.guestChats = state.guestChats.filter(c => c.id !== id);
                saveGuestChats();
                
                if (state.currentChatId === id) {
                    if (state.guestChats.length > 0) {
                        openChat(state.guestChats[0].id);
                    } else {
                        createNewGuestChat();
                    }
                } else {
                    renderChatHistory();
                }
            } else {
                fetch(`${CONFIG.BACKEND_URL}/chats/${id}`, { 
                    method: 'DELETE', 
                    headers: { 
                        'Authorization': `Bearer ${state.sessionToken}`,
                        'Content-Type': 'application/json'
                    } 
                })
                    .then(() => loadChatHistory().then(() => {
                        if (state.chats.length > 0) {
                            openChat(state.chats[0].id);
                        } else {
                            createNewChat();
                        }
                    }))
                    .catch(e => showNotification(getSafeErrorMessage(e), 'error'));
            }
        }

        async function loadChatHistory() {
            try {
                const res = await fetch(`${CONFIG.BACKEND_URL}/chats`, { 
                    headers: { 
                        'Authorization': `Bearer ${state.sessionToken}`,
                        'Content-Type': 'application/json'
                    } 
                });
                
                if (res.ok) state.chats = await res.json();
                renderChatHistory();
            } catch (e) { 
                showNotification(getSafeErrorMessage(e), 'error');
            }
        }

        function getChatById(id) { 
            return state.isGuest ? 
                state.guestChats.find(c => c.id === id) : 
                state.chats.find(c => c.id === id); 
        }
        
        function saveGuestChats() { 
            localStorage.setItem('marulgpt_guest_chats', JSON.stringify(state.guestChats)); 
        }
        
        function showTyping() { 
            document.getElementById('typingIndicator').style.display = 'block'; 
        }
        
        function hideTyping() { 
            document.getElementById('typingIndicator').style.display = 'none'; 
        }

        // Modal Functions
        function openModal(id) {
            elements.modalOverlay.classList.add('active');
            document.querySelectorAll('.modal-card').forEach(m => m.style.display = 'none');
            const modal = document.getElementById(id);
            modal.style.display = (id === 'infoModal' ? 'flex' : 'block');
            
            // Load Turnstile when auth modal opens
            if (id === 'authModal' && window.turnstile) {
                // Clear previous token
                state.turnstileToken = null;
                updateAuthButtons();
                
                // Reset form
                document.getElementById('loginForm').reset();
                document.getElementById('registerForm').reset();
                hideTurnstileError();
                
                // Load Turnstile with a small delay to ensure DOM is ready
                setTimeout(() => {
                    loadTurnstileWidget();
                }, 100);
            }
        }
        
        function closeAllModals() { 
            elements.modalOverlay.classList.remove('active'); 
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Message sending
            elements.sendMessageBtn.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keydown', e => { 
                if (e.key === 'Enter' && !e.shiftKey) { 
                    e.preventDefault(); 
                    sendMessage(); 
                } 
            });
            
            // Sidebar toggle
            elements.sidebarToggle.addEventListener('click', e => { 
                e.stopPropagation(); 
                elements.sidebar.classList.toggle('open'); 
            });
            
            document.addEventListener('click', e => {
                if (window.innerWidth <= 768 && 
                    elements.sidebar.classList.contains('open') && 
                    !elements.sidebar.contains(e.target) && 
                    e.target !== elements.sidebarToggle) {
                    elements.sidebar.classList.remove('open');
                }
            });

            // Chat actions
            elements.newChatBtn.addEventListener('click', () => state.isGuest ? createNewGuestChat() : createNewChat());
            elements.authSidebarBtn.addEventListener('click', () => openModal('authModal'));
            elements.logoutBtn.addEventListener('click', () => logoutUser());
            elements.limitAuthBtn.addEventListener('click', () => { closeAllModals(); openModal('authModal'); });
            elements.closeAuthModal.addEventListener('click', closeAllModals);
            elements.closeInfoModal.addEventListener('click', closeAllModals);
            elements.infoBtn.addEventListener('click', () => openModal('infoModal'));

            // Clear history
            elements.clearHistoryBtn.addEventListener('click', () => {
                if (!confirm("TÜM geçmiş silinecek, emin misiniz?")) return;
                
                if (state.isGuest) {
                    state.guestChats = []; 
                    saveGuestChats(); 
                    createNewGuestChat();
                    showNotification('Tüm geçmiş başarıyla temizlendi', 'success');
                } else {
                    showNotification('Üyeler için toplu silme özelliği henüz hazır değil. Lütfen tek tek siliniz.', 'info');
                }
            });

            // Donate button
            elements.donateBtn.addEventListener('click', () => {
                window.open('https://www.bynogame.com/destekle/marulgpt', '_blank');
            });

            // Auth tabs
            document.querySelectorAll('.auth-tab').forEach(t => t.addEventListener('click', (e) => {
                document.querySelectorAll('.auth-tab').forEach(x => x.classList.remove('active')); 
                e.target.classList.add('active');
                const isLogin = e.target.id === 'loginTab';
                document.getElementById('loginForm').style.display = isLogin ? 'block' : 'none';
                document.getElementById('registerForm').style.display = isLogin ? 'none' : 'block';
                
                // Reset Turnstile when switching tabs
                resetTurnstile();
            }));

            // Info tabs
            document.querySelectorAll('.info-tab').forEach(t => t.addEventListener('click', (e) => {
                document.querySelectorAll('.info-tab').forEach(x => x.classList.remove('active')); 
                e.target.classList.add('active');
                document.querySelectorAll('.info-content').forEach(x => x.style.display = 'none');
                document.getElementById(e.target.dataset.tab + 'Content').style.display = 'block';
            }));

            // Theme toggle
            elements.themeToggleBtn.addEventListener('click', toggleTheme);

            // Edit chat title
            elements.editChatTitleBtn.addEventListener('click', () => {
                if (state.isGuest) {
                    showNotification('Misafir modunda başlık düzenlenemez', 'error');
                    return;
                }
                
                const n = prompt("Yeni başlık:", elements.currentChatTitle.textContent);
                if (n && n.trim()) {
                    const newTitle = escapeHTML(n.trim());
                    elements.currentChatTitle.textContent = newTitle;
                    
                    fetch(`${CONFIG.BACKEND_URL}/chats/${state.currentChatId}`, { 
                        method: 'PUT', 
                        headers: { 
                            'Authorization': `Bearer ${state.sessionToken}`, 
                            'Content-Type': 'application/json' 
                        }, 
                        body: JSON.stringify({ title: newTitle }) 
                    })
                        .then(() => loadChatHistory())
                        .catch(e => showNotification(getSafeErrorMessage(e), 'error'));
                }
            });

            // Login form
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = elements.loginEmail.value.trim();
                const password = elements.loginPassword.value;
                
                // Validation
                if (!email || !password) {
                    showNotification('Lütfen tüm alanları doldurun', 'error');
                    return;
                }
                
                if (!validateEmail(email)) {
                    showNotification('Geçerli bir e-posta adresi girin', 'error');
                    return;
                }
                
                if (!validatePassword(password)) {
                    showNotification('Şifre en az 8 karakter olmalıdır', 'error');
                    return;
                }
                
                // Check Turnstile token
                if (!state.turnstileToken) {
                    showNotification('Lütfen güvenlik doğrulamasını tamamlayın', 'error');
                    showTurnstileError('Güvenlik doğrulaması gereklidir.');
                    return;
                }
                
                // Disable button during request
                const submitBtn = document.getElementById('loginSubmitBtn');
                const originalText = submitBtn.querySelector('span').textContent;
                submitBtn.querySelector('span').textContent = 'Giriş yapılıyor...';
                submitBtn.disabled = true;
                
                try {
                    const res = await fetch(`${CONFIG.BACKEND_URL}/login`, { 
                        method: 'POST', 
                        body: JSON.stringify({ 
                            email, 
                            password,
                            turnstileToken: state.turnstileToken 
                        }), 
                        headers: { 'Content-Type': 'application/json' } 
                    });
                    
                    const data = await res.json();
                    
                    // Reset button
                    submitBtn.querySelector('span').textContent = originalText;
                    submitBtn.disabled = false;
                    
                    if (res.ok) {
                        loginUser(data.user, data.token);
                        showNotification('Giriş başarılı!', 'success');
                        elements.loginForm.reset();
                        resetTurnstile();
                    } else {
                        showNotification(getSafeErrorMessage(data.error), 'error');
                        resetTurnstile(); // Reset on error
                    }
                } catch (e) { 
                    // Reset button
                    submitBtn.querySelector('span').textContent = originalText;
                    submitBtn.disabled = false;
                    
                    showNotification(getSafeErrorMessage(e), 'error');
                    resetTurnstile();
                }
            });

            // Register form
            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = elements.registerName.value.trim();
                const email = elements.registerEmail.value.trim();
                const password = elements.registerPassword.value;
                const passwordConfirm = elements.registerPasswordConfirm.value;
                
                // Validation
                if (!name || !email || !password || !passwordConfirm) {
                    showNotification('Lütfen tüm alanları doldurun', 'error');
                    return;
                }
                
                if (!validateName(name)) {
                    showNotification('Adınız en az 2 karakter olmalıdır', 'error');
                    return;
                }
                
                if (!validateEmail(email)) {
                    showNotification('Geçerli bir e-posta adresi girin', 'error');
                    return;
                }
                
                if (!validatePassword(password)) {
                    showNotification('Şifre en az 8 karakter olmalıdır', 'error');
                    return;
                }
                
                if (password !== passwordConfirm) {
                    showNotification('Şifreler eşleşmiyor', 'error');
                    return;
                }
                
                // Check Turnstile token
                if (!state.turnstileToken) {
                    showNotification('Lütfen güvenlik doğrulamasını tamamlayın', 'error');
                    showTurnstileError('Güvenlik doğrulaması gereklidir.');
                    return;
                }
                
                // Disable button during request
                const submitBtn = document.getElementById('registerSubmitBtn');
                const originalText = submitBtn.querySelector('span').textContent;
                submitBtn.querySelector('span').textContent = 'Kayıt yapılıyor...';
                submitBtn.disabled = true;
                
                try {
                    const res = await fetch(`${CONFIG.BACKEND_URL}/register`, { 
                        method: 'POST', 
                        body: JSON.stringify({ 
                            name, 
                            email, 
                            password,
                            turnstileToken: state.turnstileToken 
                        }), 
                        headers: { 'Content-Type': 'application/json' } 
                    });
                    
                    const data = await res.json();
                    
                    // Reset button
                    submitBtn.querySelector('span').textContent = originalText;
                    submitBtn.disabled = false;
                    
                    if (res.ok) { 
                        loginUser(data.user, data.token); 
                        showNotification('Kayıt başarılı! Hoş geldiniz!', 'success');
                        elements.registerForm.reset();
                        resetTurnstile();
                    } else {
                        showNotification(getSafeErrorMessage(data.error), 'error');
                        resetTurnstile(); // Reset on error
                    }
                } catch (e) { 
                    // Reset button
                    submitBtn.querySelector('span').textContent = originalText;
                    submitBtn.disabled = false;
                    
                    showNotification(getSafeErrorMessage(e), 'error');
                    resetTurnstile();
                }
            });
        }
    </script>
</body>

</html>
