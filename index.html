<!DOCTYPE html>
<html lang="tr" data-theme="dark">

<head>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#22c55e">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta name="description"
        content="Marul AI, gÃ¼nlÃ¼k iÅŸlerinizi kolaylaÅŸtÄ±ran gÃ¼Ã§lÃ¼ bir yapay zekÃ¢ asistanÄ±. Soru sorun, fikir isteyin, kod yazdÄ±rÄ±n, hesap yaptÄ±rÄ±nâ€”Marul AI her zaman hazÄ±r!">

    <title>Marul AI - AkÄ±llÄ± Sohbet AsistanÄ±</title>

    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit" async defer></script>

    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="favicon.png">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Marul AI",
      "url": "https://marulai.com.tr",
      "logo": "https://marulai.com.tr/favicon.png"
    }
    </script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9887645562823181"
        crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V0TG9J2D9C"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-V0TG9J2D9C');
    </script>

    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-deep: #030305;
            --bg-dark: #0d0d12;
            --bg-card: #15151c;
            --bg-card-hover: #1e1e28;
            --border-light: rgba(255, 255, 255, 0.05);
            --border-medium: rgba(255, 255, 255, 0.1);

            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --text-xs: #6b7280;

            --primary: #00ff9d;
            --primary-hover: #00cc7d;
            --primary-glow: rgba(0, 255, 157, 0.2);
            --secondary: #7000ff;
            --secondary-glow: rgba(112, 0, 255, 0.2);
            --danger: #ef4444;
            --danger-hover: #dc2626;

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 18px;
            --radius-xl: 24px;

            --sidebar-w: 280px;
            --anim-snappy: 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            --anim-smooth: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            user-select: none;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            outline: none;
            border: none;
            user-select: none;
        }

        input,
        textarea {
            font-family: inherit;
            outline: none;
            user-select: text;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            padding: 16px 20px;
            border-radius: var(--radius-md);
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            color: var(--text-main);
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(120%);
            transition: transform var(--anim-snappy);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification i {
            font-size: 1.2rem;
        }

        .notification.success i {
            color: var(--primary);
        }

        .notification.error i {
            color: var(--danger);
        }

        .notification.info i {
            color: #3b82f6;
        }

        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .sidebar {
            width: var(--sidebar-w);
            height: 100%;
            background: var(--bg-dark);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            transition: margin-left var(--anim-snappy);
            z-index: 100;
            flex-shrink: 0;
        }

        .sidebar.collapsed {
            margin-left: calc(-1 * var(--sidebar-w));
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand img {
            width: 34px;
            height: 34px;
            filter: drop-shadow(0 0 8px var(--primary-glow));
        }

        .brand span {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .new-chat-btn {
            margin: 15px 20px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            color: var(--text-main);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--anim-snappy);
        }

        .new-chat-btn:hover {
            background: var(--bg-card-hover);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 10px;
        }

        .history-item {
            padding: 12px 14px;
            margin-bottom: 6px;
            border-radius: var(--radius-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--anim-snappy);
            color: var(--text-muted);
        }

        .history-item:hover {
            background: var(--bg-card);
            color: var(--text-main);
        }

        .history-item.active {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-main);
            font-weight: 500;
        }

        .history-info {
            flex: 1;
            overflow: hidden;
        }

        .history-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9rem;
        }

        .history-date {
            font-size: 0.75rem;
            color: #3b82f6;
            margin-top: 4px;
        }

        .history-actions {
            display: none;
            gap: 8px;
        }

        .history-item:hover .history-actions {
            display: flex;
        }

        .history-actions button {
            background: none;
            color: var(--text-muted);
            padding: 4px;
            transition: color 0.2s;
        }

        .history-actions button:hover {
            color: var(--danger);
        }

        .sidebar-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-light);
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--anim-snappy);
            border: 1px solid transparent;
        }

        .user-card:hover {
            border-color: var(--border-medium);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .user-details {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            font-size: 0.75rem;
            color: var(--primary);
            margin-top: 2px;
        }

        .user-status.free {
            color: #ff9f43;
        }

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: var(--bg-deep);
            overflow: hidden;
        }

        .top-nav {
            height: 60px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-light);
            background: rgba(3, 3, 5, 0.8);
            backdrop-filter: blur(12px);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 10;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-toggle {
            background: none;
            color: var(--text-main);
            font-size: 1.2rem;
            padding: 8px;
            border-radius: 8px;
            transition: 0.2s;
        }

        .menu-toggle:hover {
            background: var(--bg-card);
        }

        .chat-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .model-selector {
            position: relative;
        }

        .model-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-medium);
            color: var(--text-main);
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--anim-snappy);
        }

        .model-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .app-download-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-medium);
            color: var(--text-main);
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--anim-snappy);
            text-decoration: none;
        }

        .app-download-btn i {
            color: #00ff9d;
        }

        .app-download-btn:hover {
            background: rgba(0, 255, 157, 0.1);
            border-color: #00ff9d;
            transform: translateY(-1px);
        }

        .model-dropdown {
            position: absolute;
            top: 120%;
            right: 0;
            width: 220px;
            background: var(--bg-dark);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            padding: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--anim-snappy);
            z-index: 20;
        }

        .model-selector.open .model-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .model-option {
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: 0.2s;
        }

        .model-option:hover {
            background: var(--bg-card);
        }

        .model-option.active {
            background: rgba(0, 255, 157, 0.1);
            border-left: 2px solid var(--primary);
        }

        .model-op-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .model-op-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .top-btn {
            background: none;
            color: var(--text-muted);
            font-size: 1.1rem;
            transition: 0.2s;
            padding: 8px;
        }

        .top-btn:hover {
            color: var(--text-main);
        }

        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .legal-links {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-light);
        }

        .legal-links a {
            font-size: 0.75rem;
            color: var(--text-muted);
            transition: 0.2s;
        }

        .legal-links a:hover {
            color: var(--text-main);
        }

        .messages-wrapper {
            flex: 1;
            padding: 80px 0 120px 0;
            overflow-y: auto;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            max-width: 500px;
            padding: 20px;
        }

        .welcome-screen img {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 20px var(--primary-glow));
        }

        .welcome-screen h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #fff, #9ca3af);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-screen p {
            color: var(--text-muted);
            font-size: 1rem;
            line-height: 1.5;
        }

        .message {
            width: 100%;
            max-width: 800px;
            padding: 10px 20px;
            margin: 10px 0;
            display: flex;
            gap: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-weight: 600;
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .message.user .message-avatar {
            display: none;
        }

        .message-content {
            flex: 1;
            max-width: calc(100% - 60px);
            user-select: text;
        }

        .message.user .message-content {
            flex: 0 1 auto;
            align-self: flex-end;
            background: #2a2a2a;
            padding: 12px 18px;
            border-radius: var(--radius-lg) 4px var(--radius-lg) var(--radius-lg);
            font-size: 0.95rem;
            line-height: 1.5;
            border: none;
            max-width: 80%;
        }

        .message.ai .message-content {
            background: transparent;
            padding: 5px 0;
            font-size: 0.95rem;
            line-height: 1.5;
            border: none;
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--text-xs);
            margin-top: 8px;
            text-align: right;
        }

        .message.user .message-time {
            text-align: left;
        }

        .markdown-body {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-main);
            max-width: 100%;
            user-select: text;
        }

        .code-block-wrapper {
            margin: 1rem 0;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--border-light);
            background: #0d0d11;
            width: fit-content;
            max-width: 100%;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1a1a22;
            padding: 8px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .code-lang {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.8rem;
            color: #8b9bb4;
            font-weight: 600;
            text-transform: lowercase;
        }

        .message-content pre {
            margin: 0;
            padding: 1.2rem;
            background: #0d0d11 !important;
            border: none;
            border-radius: 0;
            overflow-x: auto;
            max-width: 100%;
            word-wrap: normal;
        }

        .message-content pre code {
            background: none;
            padding: 0;
            border-radius: 0;
            font-size: 0.85rem;
            line-height: 1.5;
            color: #e6edf3 !important;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: #fff;
            padding: 5px 14px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            white-space: nowrap;
        }

        .copy-btn:hover {
            border-color: #00ff9d;
            background: rgba(0, 255, 157, 0.08);
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.1);
            color: #fff;
        }

        .code-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .markdown-body p {
            margin-bottom: 1em;
        }

        .markdown-body p:last-child {
            margin-bottom: 0;
        }

        .markdown-body code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
        }

        .markdown-body pre {
            background: var(--bg-dark);
            padding: 15px;
            border-radius: var(--radius-md);
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid var(--border-light);
        }

        .markdown-body pre code {
            background: none;
            padding: 0;
            color: inherit;
            border-radius: 0;
        }

        .markdown-body ul,
        .markdown-body ol {
            margin-bottom: 1em;
            padding-left: 20px;
        }

        .code-block-wrapper {
            position: relative;
            margin: 15px 0;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .code-block-wrapper pre {
            margin: 0;
            border: none;
            border-radius: 0;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid var(--border-light);
        }

        .code-lang {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
        }

        .code-actions button {
            background: none;
            color: var(--text-muted);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
        }

        .code-actions button:hover {
            color: var(--text-main);
        }

        .input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, var(--bg-deep) 60%, transparent);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-container {
            width: 100%;
            max-width: 800px;
            position: relative;
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-xl);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            padding: 6px;
            transition: border-color var(--anim-snappy);
        }

        .input-container:focus-within {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .message-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-main);
            padding: 12px 15px;
            font-size: 1rem;
            resize: none;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .message-input::placeholder {
            color: var(--text-muted);
        }

        .input-actions {
            display: flex;
            align-items: flex-end;
            padding: 5px;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--text-main);
            color: var(--bg-deep);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: var(--anim-snappy);
        }

        .send-btn:hover {
            transform: scale(1.05);
            background: var(--primary);
            color: #000;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: var(--text-muted);
        }

        .input-footer {
            margin-top: 10px;
            font-size: 0.75rem;
            color: var(--text-xs);
            text-align: center;
        }

        .typing {
            display: none;
            padding: 20px;
        }

        .typing span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--text-muted);
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--anim-snappy);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-dark);
            width: 100%;
            max-width: 420px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: var(--anim-snappy);
            overflow: hidden;
            display: none;
        }

        .modal-overlay.active .modal {
            display: block;
            transform: scale(1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .modal-close {
            background: none;
            color: var(--text-muted);
            font-size: 1.2rem;
        }

        .modal-close:hover {
            color: var(--text-main);
        }

        .modal-body {
            padding: 24px 20px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-light);
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            transition: 0.2s;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            color: var(--text-main);
            font-size: 0.95rem;
            transition: 0.2s;
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 255, 157, 0.1);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: var(--anim-snappy);
        }

        .btn-primary {
            background: var(--primary);
            color: #000;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-main);
            border: 1px solid var(--border-medium);
        }

        .btn-secondary:hover {
            background: var(--border-medium);
        }

        #turnstileWrap {
            margin: 15px 0;
            display: flex;
            justify-content: center;
            min-height: 65px;
        }

        .personalization-examples {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .personalization-examples-title {
            width: 100%;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .personalization-example-item {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-medium);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--anim-snappy);
        }

        .personalization-example-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .char-counter {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: right;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .app-download-btn span {
                display: none;
            }

            .app-download-btn {
                padding: 8px;
                border-radius: var(--radius-sm);
            }

            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                margin-left: calc(-1 * var(--sidebar-w));
            }

            .sidebar.mobile-open {
                margin-left: 0;
                box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
            }

            .message {
                padding: 10px 15px;
            }

            .input-area {
                padding: 10px;
            }

            .input-container {
                border-radius: var(--radius-lg);
            }

            .welcome-screen h1 {
                font-size: 1.5rem;
            }

            .top-nav {
                padding: 0 10px;
            }
        }
    </style>
</head>

<body>

    <div id="notification" class="notification">
        <i class="fas fa-info-circle"></i>
        <span id="notifMsg"></span>
    </div>

    <div class="app-container">

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <img src="favicon.png" alt="Marul AI">
                    <span>Marul AI</span>
                </div>
                <button class="top-btn" id="closeSidebarBtn" style="display: none;"><i
                        class="fas fa-times"></i></button>
            </div>

            <button class="new-chat-btn" id="newChatBtn">
                <i class="fas fa-plus"></i> Yeni Sohbet
            </button>

            <div class="chat-list" id="chatList">
            </div>

            <div class="sidebar-footer">
                <div class="user-card" id="userCardBtn"
                    style="display:none; flex-direction:column; align-items:flex-start; gap:10px;">
                    <div style="display:flex; align-items:center; gap:10px; width:100%;">
                        <div class="user-avatar" id="userAvatar">M</div>
                        <div class="user-details" style="flex:1;">
                            <div class="user-name" id="userNameTxt">Misafir</div>
                            <div class="user-status free" id="userStatusTxt">GiriÅŸ YapÄ±lmadÄ±</div>
                        </div>
                    </div>
                    <div
                        style="display:flex; flex-direction:column; gap:5px; width:100%; border-top: 1px solid var(--border-light); margin-top: 5px; padding-top: 10px;">
                        <button class="btn btn-secondary" id="settingsBtn"
                            style="padding: 8px; font-size: 0.8rem; justify-content: flex-start;"><i
                                class="fas fa-cog"></i> Ayarlar & DavranÄ±ÅŸ</button>
                        <button class="btn btn-secondary" id="subBtn"
                            style="padding: 8px; font-size: 0.8rem; justify-content: flex-start;"><i
                                class="fas fa-gem"></i> Abonelik Durumu</button>
                    </div>
                </div>

                <div class="auth-buttons" id="sidebarAuthBtns">
                    <button class="btn btn-primary" id="sidebarLoginBtn">GiriÅŸ Yap</button>
                </div>

                <div class="legal-links">
                    <a href="#" onclick="showAbout(); return false;">HakkÄ±mÄ±zda</a>
                    <a href="#" onclick="showPrivacy(); return false;">Gizlilik</a>
                    <a href="#" onclick="showKVKK(); return false;">KVKK</a>
                    <a href="#" onclick="showContact(); return false;">Ä°letiÅŸim</a>
                </div>
            </div>
        </aside>

        <main class="main-area">

            <nav class="top-nav">
                <div class="nav-left">
                    <button class="menu-toggle" id="menuToggleBtn"><i class="fas fa-bars"></i></button>
                    <div class="chat-title" id="chatTitleTxt">Yeni Sohbet</div>
                </div>
                <div class="nav-right">
                    <a href="https://play.google.com/store/apps/details?id=ai.marul.com" target="_blank"
                        class="app-download-btn" title="Mobil UygulamamÄ±zÄ± Ä°ndirin">
                        <i class="fab fa-google-play"></i> <span>UygulamayÄ± Ä°ndir</span>
                    </a>
                    <div class="model-selector" id="modelSelector">
                        <button class="model-btn" id="modelBtn">
                            <span id="selectedModelTxt">Marul V7</span> <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="model-dropdown">
                            <div class="model-option active" data-model="marul">
                                <div class="model-op-name">Marul V7</div>
                                <div class="model-op-desc">Yerli ve milli modelimiz</div>
                            </div>
                            <div class="model-option" data-model="llama">
                                <div class="model-op-name">Llama 3 (70B)</div>
                                <div class="model-op-desc">AÃ§Ä±k kaynak devi</div>
                            </div>
                        </div>
                    </div>
                    <button class="top-btn" id="logoutBtn" title="Ã‡Ä±kÄ±ÅŸ Yap" style="display: none;"><i
                            class="fas fa-sign-out-alt"></i></button>
                </div>
            </nav>

            <div class="messages-wrapper" id="msgContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <img src="favicon.png" alt="Marul AI">
                    <h1>NasÄ±l yardÄ±mcÄ± olabilirim?</h1>
                    <p>SorularÄ±nÄ±zÄ± yanÄ±tlamak, analiz yapmak veya kod yazmak iÃ§in buradayÄ±m.</p>
                </div>
                <div class="typing" id="typingInd"><span></span><span></span><span></span></div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <textarea id="msgInput" class="message-input" rows="1" placeholder="Marul AI'ye mesaj gÃ¶nder..."
                        autofocus></textarea>
                    <div class="input-actions">
                        <button class="send-btn" id="sendBtn" disabled><i class="fas fa-arrow-up"></i></button>
                    </div>
                </div>
                <div class="input-footer">Marul AI hata yapabilir. Ã–nemli bilgileri doÄŸrulayÄ±n.</div>
            </div>

        </main>
    </div>

    <div class="modal-overlay" id="authOverlay">
        <div class="modal" id="authModal">
            <div class="modal-header">
                <div class="modal-title">HesabÄ±nÄ±za EriÅŸin</div>
                <button class="modal-close" id="closeAuthBtn"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">

                <form id="loginForm">
                    <p style="color:var(--text-muted); font-size: 0.9rem; margin-bottom:20px; text-align:center;">Marul
                        AI hesabÄ±nÄ±za giriÅŸ yaparak sohbete devam edin</p>
                    <div class="form-group">
                        <label class="form-label" style="font-weight: 500;">E-posta Adresi</label>
                        <input type="email" class="form-control" id="loginEmail" placeholder="ornek@mail.com"
                            style="padding: 12px; font-size: 1rem;" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 25px;">
                        <label class="form-label" style="font-weight: 500;">Åžifre</label>
                        <input type="password" class="form-control" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                            style="padding: 12px; font-size: 1rem;" required>
                    </div>
                    <div id="turnstileWrapLogin" class="turnstile-container"
                        style="min-height: 65px; margin-bottom: 20px; display:flex; justify-content:center;"></div>
                    <button type="submit" class="btn btn-primary" id="loginSubBtn"
                        style="width: 100%; padding: 12px; font-size: 1rem; font-weight: 600;">GiriÅŸ Yap</button>

                    <div style="text-align:center; margin-top: 25px; font-size: 0.9rem; color: var(--text-muted);">
                        HesabÄ±nÄ±z yok mu? <a href="#" id="switchToRegLink"
                            style="color: var(--primary); font-weight: 600; text-decoration: none;">Hemen KayÄ±t Olun</a>
                    </div>
                </form>

                <form id="registerForm" style="display: none;">
                    <p style="color:var(--text-muted); font-size: 0.9rem; margin-bottom:20px; text-align:center;">
                        HÄ±zlÄ±ca hesap oluÅŸturun ve kullanmaya baÅŸlayÄ±n</p>
                    <div class="form-group">
                        <label class="form-label" style="font-weight: 500;">Ad Soyad</label>
                        <input type="text" class="form-control" id="regName" placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z"
                            style="padding: 12px; font-size: 1rem;" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-weight: 500;">E-posta Adresi</label>
                        <input type="email" class="form-control" id="regEmail" placeholder="ornek@mail.com"
                            style="padding: 12px; font-size: 1rem;" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label" style="font-weight: 500;">Åžifre</label>
                        <input type="password" class="form-control" id="regPass" placeholder="En az 6 karakter"
                            style="padding: 12px; font-size: 1rem;" required>
                    </div>
                    <div id="turnstileWrapReg" class="turnstile-container"
                        style="min-height: 65px; margin-bottom: 15px; display:flex; justify-content:center;"></div>

                    <p
                        style="font-size:0.8rem; color:var(--text-muted); margin-bottom:20px; text-align:center; line-height: 1.5;">
                        Hesap oluÅŸturarak
                        <a href="#" onclick="showTerms(); return false;"
                            style="color:var(--primary); font-weight: 500;">KullanÄ±cÄ± SÃ¶zleÅŸmesi</a>'ni ve
                        <a href="#" onclick="showKVKK(); return false;"
                            style="color:var(--primary); font-weight: 500;">KVKK AydÄ±nlatma Metni</a>'ni kabul etmiÅŸ
                        olursunuz.
                    </p>
                    <button type="submit" class="btn btn-primary" id="regSubBtn"
                        style="width: 100%; padding: 12px; font-size: 1rem; font-weight: 600;">Hesap OluÅŸtur</button>

                    <div style="text-align:center; margin-top: 25px; font-size: 0.9rem; color: var(--text-muted);">
                        Zaten hesabÄ±nÄ±z var mÄ±? <a href="#" id="switchToLoginLink"
                            style="color: var(--primary); font-weight: 600; text-decoration: none;">GiriÅŸ YapÄ±n</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsOverlay">
        <div class="modal" id="settingsModal">
            <div class="modal-header">
                <div class="modal-title">KiÅŸiselleÅŸtirme AyarlarÄ±</div>
                <button class="modal-close" id="closeSettingsBtn"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:15px;"><i
                        class="fas fa-wand-magic-sparkles" style="color:var(--primary); margin-right:5px;"></i> Marul
                    AI'ye size nasÄ±l yanÄ±t
                    vermesi gerektiÄŸini sÃ¶yleyin. Ã–zelleÅŸtirilmiÅŸ talimatlar genel sorulara verilen yanÄ±tlarÄ±
                    etkileyecektir.</p>
                <form id="settingsForm">
                    <div class="form-group">
                        <label class="form-label">Sistem TalimatlarÄ±</label>
                        <textarea class="form-control" id="sysPromptInput" rows="4"
                            placeholder="Ã–rn: Bana hep sen diye hitap et ve yanÄ±tlarÄ±nÄ± olabildiÄŸince kÄ±sa tut..."
                            maxlength="600"></textarea>
                        <div class="char-counter" id="sysPromptCount">0 / 600</div>
                    </div>

                    <div class="personalization-examples">
                        <div class="personalization-examples-title">
                            <i class="fas fa-lightbulb"></i> Ã–rnek talimatlar
                        </div>
                        <span class="personalization-example-item" data-text="Samimi ve arkadaÅŸÃ§a konuÅŸ">Samimi
                            konuÅŸ</span>
                        <span class="personalization-example-item" data-text="KÄ±sa ve Ã¶z cevaplar ver">KÄ±sa
                            cevaplar</span>
                        <span class="personalization-example-item" data-text="DetaylÄ± ve aÃ§Ä±klayÄ±cÄ± ol">DetaylÄ±
                            aÃ§Ä±kla</span>
                        <span class="personalization-example-item" data-text="Bol emoji kullan ðŸ˜Š">Bol emoji</span>
                        <span class="personalization-example-item" data-text="Resmi ve profesyonel ol">Profesyonel
                            ol</span>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" id="clearSettingsBtn" style="flex:1;"><i
                                class="fas fa-eraser"></i> Temizle</button>
                        <button type="submit" class="btn btn-primary" id="saveSettingsBtn" style="flex:2;"><i
                                class="fas fa-save"></i> Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="subOverlay">
        <div class="modal" id="subModal">
            <div class="modal-header">
                <div class="modal-title">Hesap & Abonelik Durumu</div>
                <button class="modal-close" id="closeSubBtn"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;"><i
                            class="fas fa-crown"></i>
                    </div>
                    <h3 id="subPlanName" style="margin-bottom: 5px;">Ãœcretsiz Plan</h3>
                    <p id="subDetails" style="color:var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
                        Bu sohbette 25 mesaj hakkÄ±nÄ±z bulunmaktadÄ±r.
                    </p>
                    <div id="subProgressBar"
                        style="width:100%; height:8px; background:var(--bg-card); border-radius:4px; margin-bottom:8px; overflow:hidden; border:1px solid var(--border-medium);">
                        <div id="subProgressFill"
                            style="width:0%; height:100%; background:var(--primary); transition:width 0.3s;"></div>
                    </div>
                    <p id="subUsageText" style="font-size:0.8rem; color:var(--text-muted); margin-bottom: 15px;">0 / 25
                        Mesaj KullanÄ±ldÄ± (Bu Sohbet)</p>

                    <button class="btn btn-primary" id="upgradeBtn"
                        style="display:none; margin: 0 auto; max-width: 250px;">
                        <i class="fas fa-gem"></i> Marul AI Plus'a GeÃ§
                    </button>

                    <button class="btn btn-secondary" id="subNewChatBtn"
                        style="display:none; margin: 10px auto 0 auto; max-width: 250px;">
                        <i class="fas fa-plus"></i> Yeni Sohbet BaÅŸlat
                    </button>
                </div>

                <div style="border-top: 1px solid var(--border-light); padding-top: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: var(--text-main); font-size: 1rem;">Hesap Bilgileri</h4>
                    <div style="display: grid; gap: 10px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(128, 128, 128, 0.05); border-radius: var(--radius-sm); border: 1px solid var(--border-light);">
                            <span style="color: var(--text-muted); font-size: 0.9rem;">Ä°sim</span>
                            <span id="accountNameInfo"
                                style="font-weight: 600; color: var(--text-main); font-size: 0.95rem;">-</span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(128, 128, 128, 0.05); border-radius: var(--radius-sm); border: 1px solid var(--border-light);">
                            <span style="color: var(--text-muted); font-size: 0.9rem;">E-posta</span>
                            <span id="accountEmailInfo"
                                style="font-weight: 600; color: var(--text-main); font-size: 0.95rem;">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="legalOverlay">
        <div class="modal" id="legalModal">
            <div class="modal-header">
                <div class="modal-title" id="legalTitle">Bilgi</div>
                <button class="modal-close" id="closeLegalBtn"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="legalContent" style="color:var(--text-muted); line-height:1.6; font-size:0.95rem;"></div>
                <button class="btn btn-secondary" style="margin-top: 20px;"
                    onclick="document.getElementById('legalOverlay').classList.remove('active');">AnladÄ±m</button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const CONFIG = {
                BACKEND_URL: 'https://marulgpt-backend.marulgpt.workers.dev', 
                TURNSTILE_SITE_KEY: '0x4AAAAAACIwky-WL9EDj91G'
            };

            const STORAGE_KEY = btoa('marul_s_token');
            const DATA_KEY = btoa('marul_s_user');

            let __token = sessionStorage.getItem(STORAGE_KEY) || null;
            let __user = JSON.parse(sessionStorage.getItem(DATA_KEY) || 'null');

            let state = {
                isGuest: !__token,
                guestQuestionsLeft: parseInt(localStorage.getItem('guest_left') || '10'),
                currentChatId: 'new',
                chats: [],
                guestChats: JSON.parse(localStorage.getItem('g_chats') || '[]'),
                selectedModel: 'marul',
                turnstileWidgetId: null,
                tsToken: null
            };

            const el = {
                msgInput: document.getElementById('msgInput'),
                sendBtn: document.getElementById('sendBtn'),
                msgContainer: document.getElementById('msgContainer'),
                welcomeScreen: document.getElementById('welcomeScreen'),
                typingInd: document.getElementById('typingInd'),
                chatList: document.getElementById('chatList'),
                newChatBtn: document.getElementById('newChatBtn'),
                chatTitleTxt: document.getElementById('chatTitleTxt'),

                userCardBtn: document.getElementById('userCardBtn'),
                userNameTxt: document.getElementById('userNameTxt'),
                userStatusTxt: document.getElementById('userStatusTxt'),
                userAvatar: document.getElementById('userAvatar'),
                logoutBtn: document.getElementById('logoutBtn'),

                menuToggleBtn: document.getElementById('menuToggleBtn'),
                sidebar: document.getElementById('sidebar'),
                closeSidebarBtn: document.getElementById('closeSidebarBtn'),

                modelBtn: document.getElementById('modelBtn'),
                modelSelector: document.getElementById('modelSelector'),
                selectedModelTxt: document.getElementById('selectedModelTxt'),

                authOverlay: document.getElementById('authOverlay'),
                closeAuthBtn: document.getElementById('closeAuthBtn'),
                loginForm: document.getElementById('loginForm'),
                registerForm: document.getElementById('registerForm'),

                settingsBtn: document.getElementById('settingsBtn'),
                subBtn: document.getElementById('subBtn'),
                sidebarAuthBtns: document.getElementById('sidebarAuthBtns'),
                sidebarLoginBtn: document.getElementById('sidebarLoginBtn'),

                settingsOverlay: document.getElementById('settingsOverlay'),
                closeSettingsBtn: document.getElementById('closeSettingsBtn'),
                settingsForm: document.getElementById('settingsForm'),
                sysPromptInput: document.getElementById('sysPromptInput'),
                saveSettingsBtn: document.getElementById('saveSettingsBtn'),

                subOverlay: document.getElementById('subOverlay'),
                closeSubBtn: document.getElementById('closeSubBtn'),
                subPlanName: document.getElementById('subPlanName'),
                subDetails: document.getElementById('subDetails'),
                subProgressFill: document.getElementById('subProgressFill'),
                subUsageText: document.getElementById('subUsageText'),
                upgradeBtn: document.getElementById('upgradeBtn'),
                subNewChatBtn: document.getElementById('subNewChatBtn'),
                accountNameInfo: document.getElementById('accountNameInfo'),
                accountEmailInfo: document.getElementById('accountEmailInfo'),

                legalOverlay: document.getElementById('legalOverlay'),
                legalTitle: document.getElementById('legalTitle'),
                legalContent: document.getElementById('legalContent'),
                closeLegalBtn: document.getElementById('closeLegalBtn')
            };

            window.openLegalModal = function (title, htmlContent) {
                el.legalTitle.textContent = title;
                el.legalContent.innerHTML = htmlContent;
                el.legalOverlay.classList.add('active');
            };

            window.showAbout = function () {
                openLegalModal('HakkÄ±mÄ±zda', `
                    <p style="margin-bottom: 15px;"><strong>Marul AI</strong>, 2024 yÄ±lÄ±nda geliÅŸtirilmeye baÅŸlanan yerli ve milli, yenilikÃ§i bir yapay zeka asistanÄ±dÄ±r.</p>
                    <p style="margin-bottom: 15px;">AmacÄ±mÄ±z, doÄŸal dil iÅŸleme teknolojilerini kullanarak TÃ¼rkiye'deki ve dÃ¼nyadaki kullanÄ±cÄ±lara en hÄ±zlÄ±, en gÃ¼venli ve akÄ±llÄ± Ã§Ã¶zÃ¼mleri sunmaktÄ±r. Marul AI V7 modelimiz sayesinde TÃ¼rkÃ§e dil yapÄ±sÄ±nÄ± mÃ¼kemmel anlar ve sizinle bir insan doÄŸallÄ±ÄŸÄ±nda sohbet eder.</p>
                    <p>SÃ¼rekli geliÅŸen altyapÄ±mÄ±z ile programlama, iÃ§erik Ã¼retimi, dil Ã§evirisi ve akademik araÅŸtÄ±rmalara kadar pek Ã§ok alanda size destek olmayÄ± hedefliyoruz.</p>
                `);
            };

            window.showPrivacy = function () {
                openLegalModal('Gizlilik PolitikasÄ±', `
                    <p style="margin-bottom: 15px;"><strong>1. Veri Toplama ve KullanÄ±mÄ±:</strong> Marul AI hizmetini kullanÄ±rken girdiÄŸiniz sohbet mesajlarÄ±, hizmet kalitesini artÄ±rmak ve modelimizi eÄŸitmek amacÄ±yla ÅŸifrelenerek saklanabilir. HiÃ§bir veriniz 3. taraflarla reklam amaÃ§lÄ± paylaÅŸÄ±lmaz.</p>
                    <p style="margin-bottom: 15px;"><strong>2. Veri GÃ¼venliÄŸi:</strong> SunucularÄ±mÄ±zda saklanan tÃ¼m bilgiler yetkisiz eriÅŸimlere karÅŸÄ± sektÃ¶r standartlarÄ±nda ÅŸifrelenmiÅŸtir. Hesap ÅŸifreleriniz geri dÃ¶ndÃ¼rÃ¼lemez (hash) algoritmalarla korunmaktadÄ±r.</p>
                    <p style="margin-bottom: 15px;"><strong>3. KullanÄ±cÄ± HaklarÄ±:</strong> Profilinize dilediÄŸiniz an eriÅŸebilir, bilgilerinizi gÃ¼ncelleyebilir veya 'HesabÄ±mÄ± Sil' talebinde bulunabilirsiniz. Hesap silme iÅŸleminin ardÄ±ndan verileriniz anonimleÅŸtirilecektir.</p>
                    <p><strong>4. Ã‡erez PolitikasÄ±:</strong> Oturum bilgilerinizi gÃ¼vende tutmak iÃ§in tarayÄ±cÄ± Ã¼zerinde Ã§erez ve SessionStorage/LocalStorage mantÄ±ÄŸÄ± ile Ã§alÄ±ÅŸmaktayÄ±z.</p>
                `);
            };

            window.showKVKK = function () {
                openLegalModal('KVKK AydÄ±nlatma Metni', `
                    <p style="margin-bottom: 15px;"><strong>KiÅŸisel Verilerin KorunmasÄ± Kanunu KapsamÄ±nda AydÄ±nlatma Metni</strong></p>
                    <p style="margin-bottom: 15px;">Marul AI olarak, 6698 sayÄ±lÄ± KiÅŸisel Verilerin KorunmasÄ± Kanunu ("KVKK") uyarÄ±nca, "Veri Sorumlusu" sÄ±fatÄ±yla, kiÅŸisel verilerinizi Kanunâ€™a uygun olarak iÅŸlemekteyiz.</p>
                    <p style="margin-bottom: 15px;"><strong>a. Ä°ÅŸlenen KiÅŸisel Verileriniz ve Ä°ÅŸlenme AmaÃ§larÄ±:</strong> Ad, soyad ve e-posta adresiniz, sistemde size profil oluÅŸturmak ve yasal bir muhatap saÄŸlamak amacÄ±yla saklanmaktadÄ±r. Sohbet geÃ§miÅŸleriniz hizmet optimize iÅŸlemlerinde kullanÄ±m iÃ§in kaydedilir.</p>
                    <p style="margin-bottom: 15px;"><strong>b. KiÅŸisel Verilerin AktarÄ±mÄ±:</strong> Verileriniz yasal olarak yetkili kamu kurumlarÄ± hariÃ§, yurtiÃ§inde veya yurtdÄ±ÅŸÄ±nda hiÃ§bir kiÅŸi ya da firmaya aktarÄ±lmamaktadÄ±r.</p>
                    <p style="margin-bottom: 15px;"><strong>c. KVKK Madde 11 KapsamÄ±nda HaklarÄ±nÄ±z:</strong> KiÅŸisel verilerinizin iÅŸlenip iÅŸlenmediÄŸini Ã¶ÄŸrenme, yanlÄ±ÅŸ ise dÃ¼zeltilmesini isteme, kanunda Ã¶ngÃ¶rÃ¼len ÅŸartlar Ã§erÃ§evesinde silinmesini talep etme haklarÄ±na sahipsiniz.</p>
                    <p>BaÅŸvurularÄ±nÄ±zÄ± <strong>marulai.resmi@gmail.com</strong> adresi Ã¼zerinden yazÄ±lÄ± olarak iletebilirsiniz.</p>
                `);
            };

            window.showTerms = function () {
                openLegalModal('KullanÄ±cÄ± SÃ¶zleÅŸmesi', `
                    <p style="margin-bottom: 15px;"><strong>1. Taraflar ve Onay:</strong> Bu sÃ¶zleÅŸme, Marul AI hizmetlerini kullanan her birey (KullanÄ±cÄ±) ile platform yÃ¶netimi arasÄ±nda elektronik ortamda onaylanmÄ±ÅŸtÄ±r.</p>
                    <p style="margin-bottom: 15px;"><strong>2. Hizmet KullanÄ±m ÅžartlarÄ±:</strong> Marul AI, genel bilgi verme amaÃ§lÄ± bir yapay zekadÄ±r. HatalÄ±, eksik veya yanÄ±ltÄ±cÄ± bilgi sunabileceÄŸi haller mevcuttur. TÄ±bbi, yasal, finansal konularda verilen tavsiyelerin sorumluluÄŸu kullanÄ±cÄ±ya aittir.</p>
                    <p style="margin-bottom: 15px;"><strong>3. YasaklÄ± Aktiviteler:</strong> Sistemi zorlamak, spam yapmak, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± istismar etmek yasaktÄ±r. Tespiti halinde hesaba eriÅŸim kalÄ±cÄ± olarak kesilir.</p>
                    <p><strong>4. DeÄŸiÅŸiklik HaklarÄ±:</strong> Marul AI, sistem altyapÄ±sÄ±nda ve kullanÄ±m sÃ¶zleÅŸmesinde kullanÄ±cÄ±lara bildirim yapmak ÅŸartÄ±yla deÄŸiÅŸiklik yapma hakkÄ±nÄ± saklÄ± tutar.</p>
                `);
            };

            window.showContact = function () {
                openLegalModal('Ä°letiÅŸim Bilgileri', `
                    <p style="margin-bottom: 20px;">Marul AI platformuyla ilgili her tÃ¼rlÃ¼ soru, gÃ¶rÃ¼ÅŸ, Ã¶neri veya teknik destek talebi iÃ§in bizimle iletiÅŸime geÃ§ebilirsiniz.</p>
                    <div style="background: var(--bg-card); padding: 20px; border-radius: var(--radius-md); text-align: center; border: 1px solid var(--border-light);">
                        <i class="fas fa-envelope" style="font-size: 2rem; color: var(--primary); margin-bottom: 15px;"></i>
                        <h4 style="margin-bottom: 10px; color: var(--text-main);">E-Posta Adresimiz</h4>
                        <a href="mailto:marulai.resmi@gmail.com" style="color: var(--primary); font-size: 1.1rem; font-weight: 600; text-decoration: none;">marulai.resmi@gmail.com</a>
                    </div>
                    <p style="margin-top: 20px; font-size: 0.9rem;">Destek taleplerinize en geÃ§ 48 iÅŸ saati iÃ§erisinde dÃ¶nÃ¼ÅŸ yapÄ±lacaktÄ±r.</p>
                `);
            };

            function showNotif(msg, type = 'info') {
                const notif = document.getElementById('notification');
                const map = { success: 'check-circle', error: 'exclamation-triangle', info: 'info-circle' };
                notif.className = `notification show ${type}`;
                notif.innerHTML = `<i class="fas fa-${map[type]}"></i> <span>${escapeHTML(msg)}</span>`;
                setTimeout(() => { notif.classList.remove('show'); }, 3000);
            }

            function escapeHTML(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.innerText = str;
                return div.innerHTML;
            }

            window.copyToClipboard = function (textToCopy, btn) {
                navigator.clipboard.writeText(decodeURIComponent(textToCopy)).then(() => {
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> KopyalandÄ±';
                    btn.style.color = '#00ff9d';
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.style.color = '';
                    }, 2000);
                }).catch(() => {
                    showNotif('Kopyalama baÅŸarÄ±sÄ±z', 'error');
                });
            };

            function addCodeActions(container) {
                container.querySelectorAll('pre').forEach(pre => {
                    const codeEl = pre.querySelector('code');
                    if (!codeEl) return;
                    const codeText = encodeURIComponent(codeEl.innerText);
                    const lang = codeEl.className.replace('language-', '') || 'code';

                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-block-wrapper';
                    pre.parentNode.insertBefore(wrapper, pre);

                    const header = document.createElement('div');
                    header.className = 'code-header';

                    const langLabel = document.createElement('div');
                    langLabel.className = 'code-lang';
                    langLabel.textContent = lang;
                    header.appendChild(langLabel);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'code-actions';

                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-btn';
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i> Kopyala';
                    copyBtn.onclick = () => copyToClipboard(codeText, copyBtn);
                    actionsDiv.appendChild(copyBtn);

                    header.appendChild(actionsDiv);
                    wrapper.appendChild(header);
                    wrapper.appendChild(pre);
                });
            }

            async function safeFetch(endpoint, options = {}) {
                const headers = { 'Content-Type': 'application/json', ...options.headers };
                if (__token) headers['Authorization'] = `Bearer ${__token}`;

                try {
                    const res = await fetch(`${CONFIG.BACKEND_URL}${endpoint}`, { ...options, headers });
                    const json = await res.json().catch(() => ({}));
                    return { ok: res.ok, status: res.status, data: json };
                } catch (err) {
                    return { ok: false, status: 500, data: { error: 'AÄŸ baÄŸlantÄ±sÄ± hatasÄ±.' } };
                }
            }

            function updateAccountUI() {
                if (__user) {
                    el.userCardBtn.style.display = 'flex';
                    if (el.sidebarAuthBtns) el.sidebarAuthBtns.style.display = 'none';
                    el.userNameTxt.textContent = __user.name;
                    el.userStatusTxt.textContent = state.isPremium ? 'Premium Ãœye' : 'Ãœcretsiz Ãœye';
                    el.userAvatar.textContent = __user.name.charAt(0).toUpperCase();
                    el.userStatusTxt.className = state.isPremium ? 'user-status premium' : 'user-status free';
                    el.logoutBtn.style.display = 'block';
                    el.settingsBtn.style.display = 'block';
                    el.subBtn.style.display = 'block';
                } else {
                    el.userCardBtn.style.display = 'flex'; 
                    if (el.sidebarAuthBtns) el.sidebarAuthBtns.style.display = 'flex';
                    el.userNameTxt.textContent = 'Misafir KullanÄ±cÄ±';
                    el.userStatusTxt.textContent = `${state.guestQuestionsLeft} Hak KaldÄ±`;
                    el.userAvatar.textContent = 'M';
                    el.userStatusTxt.className = 'user-status free';
                    el.logoutBtn.style.display = 'none';
                    el.settingsBtn.style.display = 'none'; 
                    el.subBtn.style.display = 'none'; 
                }
                renderSidebarChats();
            }

            function toggleSidebar() {
                if (window.innerWidth <= 768) {
                    el.sidebar.classList.toggle('mobile-open');
                    el.closeSidebarBtn.style.display = el.sidebar.classList.contains('mobile-open') ? 'block' : 'none';
                } else {
                    el.sidebar.classList.toggle('collapsed');
                }
            }

            function scrollToBottom() {
                window.scrollTo(0, document.body.scrollHeight);
                el.msgContainer.scrollTop = el.msgContainer.scrollHeight;
            }


            async function initApp() {
                updateAccountUI();
                if (__token) {
                    const check = await safeFetch('/verify-session');
                    if (check.ok && check.data.valid) {
                        state.isPremium = check.data.isPremium;
                        updateAccountUI(); 
                        await loadRemoteChats();
                    } else {
                        logout();
                    }
                } else {
                    if (state.guestChats.length === 0) createLocalChat();
                    else openChat(state.guestChats[0].id);
                }
            }

            async function loadRemoteChats() {
                const res = await safeFetch('/chats');
                if (res.ok) {
                    state.chats = res.data;
                    renderSidebarChats();
                    if (state.chats.length > 0) openChat(state.chats[0].id);
                    else createRemoteChat();
                }
            }

            function createLocalChat() {
                const nc = { id: 'g_' + Date.now(), title: 'Yeni Sohbet', messages: [], updated_at: new Date() };
                state.guestChats.unshift(nc);
                localStorage.setItem('g_chats', JSON.stringify(state.guestChats));
                openChat(nc.id);
            }

            async function createRemoteChat() {
                const res = await safeFetch('/chats', { method: 'POST' });
                if (res.ok) {
                    state.chats.unshift(res.data);
                    openChat(res.data.id);
                } else {
                    showNotif(res.data.error || 'Sohbet oluÅŸturulamadÄ±', 'error');
                }
            }

            function renderSidebarChats() {
                el.chatList.innerHTML = '';
                const list = state.isGuest ? state.guestChats : state.chats;
                list.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));

                const formatChatDate = (dateString) => {
                    if (!dateString) return '';
                    const d = new Date(dateString);
                    if (isNaN(d.getTime())) return '';
                    const months = ['Oca', 'Åžub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'AÄŸu', 'Eyl', 'Eki', 'Kas', 'Ara'];
                    const day = d.getDate();
                    const month = months[d.getMonth()];
                    const hours = d.getHours().toString().padStart(2, '0');
                    const mins = d.getMinutes().toString().padStart(2, '0');
                    return `${day} ${month} ${hours}:${mins}`;
                };

                list.forEach(c => {
                    const item = document.createElement('div');
                    item.className = `history-item ${c.id === state.currentChatId ? 'active' : ''}`;
                    const dateFormatted = formatChatDate(c.updated_at);

                    item.innerHTML = `
                    <div class="history-info">
                        <div class="history-title">${escapeHTML(c.title)}</div>
                        <div class="history-date">${dateFormatted}</div>
                    </div>
                    <div class="history-actions">
                        <button title="Sil" data-id="${c.id}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                    item.onclick = (e) => {
                        if (e.target.closest('button')) deleteChat(c.id);
                        else { openChat(c.id); if (window.innerWidth <= 768) toggleSidebar(); }
                    };
                    el.chatList.appendChild(item);
                });
            }

            async function deleteChat(id) {
                if (!confirm('Bu sohbeti silmek istediÄŸinize emin misiniz?')) return;
                if (state.isGuest) {
                    state.guestChats = state.guestChats.filter(x => x.id !== id);
                    localStorage.setItem('g_chats', JSON.stringify(state.guestChats));
                    if (state.currentChatId === id) { state.guestChats.length ? openChat(state.guestChats[0].id) : createLocalChat(); }
                    else renderSidebarChats();
                } else {
                    await safeFetch(`/chats/${id}`, { method: 'DELETE' });
                    state.chats = state.chats.filter(x => x.id !== id);
                    if (state.currentChatId === id) { state.chats.length ? openChat(state.chats[0].id) : createRemoteChat(); }
                    else renderSidebarChats();
                }
            }

            async function openChat(id) {
                state.currentChatId = id;
                const chat = (state.isGuest ? state.guestChats : state.chats).find(x => x.id === id);
                el.chatTitleTxt.textContent = chat ? chat.title : 'Sohbet';

                el.msgInput.disabled = false;
                el.sendBtn.disabled = false;
                el.msgInput.placeholder = 'Marul AI ile mesajlaÅŸÄ±n...';
                el.subNewChatBtn.style.display = 'none';

                Array.from(el.msgContainer.children).forEach(c => {
                    if (c.id !== 'welcomeScreen' && c.id !== 'typingInd') c.remove();
                });
                el.welcomeScreen.style.display = 'flex';
                renderSidebarChats();

                if (state.isGuest) {
                    if (chat && chat.messages.length) {
                        el.welcomeScreen.style.display = 'none';
                        chat.messages.forEach(m => appendHtmlMsg(m.role, m.content));

                        const userMsgs = chat.messages.filter(m => m.role === 'user').length;
                        if (userMsgs >= 25 && state.guestQuestionsLeft <= 0) {
                            el.subNewChatBtn.style.display = 'block';
                            el.msgInput.disabled = true;
                            el.sendBtn.disabled = true;
                            el.msgInput.placeholder = 'Misafir mesaj limitiniz doldu.';
                        }
                    }
                } else {
                    const res = await safeFetch(`/chats/${id}/messages`);
                    if (res.ok && res.data.length) {
                        el.welcomeScreen.style.display = 'none';
                        res.data.forEach(m => appendHtmlMsg(m.role === 'user' ? 'user' : 'ai', m.content));

                        const subRes = await safeFetch(`/subscription?chatId=${id}`);
                        if (subRes.ok && !subRes.data.isSubscribed && !state.isPremium) {
                            const count = subRes.data.messageCount;
                            const limit = subRes.data.limit;
                            if (count >= limit) {
                                el.subNewChatBtn.style.display = 'block';
                                el.msgInput.disabled = true;
                                el.sendBtn.disabled = true;
                                el.msgInput.placeholder = 'Bu sohbetteki mesaj limitiniz doldu.';
                            }
                        }
                    }
                }
            }

            function appendHtmlMsg(role, text) {
                el.welcomeScreen.style.display = 'none';
                const div = document.createElement('div');
                div.className = `message ${role}`;

                if (role === 'ai') {
                    const html = marked.parse(text);
                    div.innerHTML = `<div class="message-avatar"><img src="favicon.png"></div>
                                 <div class="message-content">
                                    <div class="markdown-body">${html}</div>
                                 </div>`;
                    addCodeActions(div);
                    div.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
                } else {
                    const initial = __user ? __user.name.charAt(0).toUpperCase() : 'M';
                    div.innerHTML = `<div class="message-content">${escapeHTML(text).replace(/\n/g, '<br>')}</div>
                                 <div class="message-avatar">${initial}</div>`;
                }

                el.msgContainer.insertBefore(div, el.typingInd);
                scrollToBottom();
            }

            async function handleSend() {
                const text = el.msgInput.value.trim();
                if (!text) return;

                if (state.isGuest && state.guestQuestionsLeft <= 0) {
                    showNotif('Misafir mesaj limitiniz doldu. LÃ¼tfen giriÅŸ yapÄ±n.', 'error');
                    el.authOverlay.classList.add('active');
                    el.loginForm.style.display = 'block';
                    el.registerForm.style.display = 'none';
                    setTimeout(() => initTurnstile('login'), 150);
                    return;
                }

                el.msgInput.value = '';
                el.msgInput.style.height = 'auto';
                el.sendBtn.disabled = true;
                appendHtmlMsg('user', text);
                el.typingInd.style.display = 'block';
                scrollToBottom();

                if (state.isGuest) {
                    state.guestQuestionsLeft--;
                    localStorage.setItem('guest_left', state.guestQuestionsLeft);
                    updateAccountUI();

                    const chat = state.guestChats.find(x => x.id === state.currentChatId);
                    let ctx = "";
                    if (chat) {
                        chat.messages.slice(-6).forEach(m => ctx += `${m.role}: ${m.content}\n`);
                        chat.messages.push({ role: 'user', content: text });
                        if (chat.title === 'Yeni Sohbet') chat.title = text.substring(0, 30);
                        chat.updated_at = new Date();
                        localStorage.setItem('g_chats', JSON.stringify(state.guestChats));
                    }
                    renderSidebarChats();

                    const res = await safeFetch('/guest-chat', {
                        method: 'POST',
                        body: JSON.stringify({ message: (ctx + text), model: state.selectedModel })
                    });

                    el.typingInd.style.display = 'none';
                    if (res.ok) {
                        appendHtmlMsg('ai', res.data.response);
                        chat.messages.push({ role: 'ai', content: res.data.response });
                        localStorage.setItem('g_chats', JSON.stringify(state.guestChats));
                    } else {
                        appendHtmlMsg('ai', 'Hata: ' + (res.data.error || 'BaÄŸlantÄ± sorunu'));
                    }
                } else {
                    const res = await safeFetch('/chat', {
                        method: 'POST',
                        body: JSON.stringify({ chatId: state.currentChatId, message: text, model: state.selectedModel })
                    });

                    el.typingInd.style.display = 'none';
                    if (res.ok) {
                        appendHtmlMsg('ai', res.data.response);
                        if (res.data.isNewChat) {
                            state.currentChatId = res.data.chatId;
                            loadRemoteChats();
                        }
                    } else {
                        if (res.data.error === 'MESSAGE_LIMIT_REACHED') {
                            showNotif('SÄ±nÄ±ra ulaÅŸtÄ±nÄ±z. Devam etmek iÃ§in premium paket edinin.', 'error');
                            el.msgInput.disabled = true;
                            el.sendBtn.disabled = true;
                            el.msgInput.placeholder = 'Bu sohbetteki mesaj limitiniz doldu.';
                            setTimeout(() => {
                                el.subBtn.click();
                            }, 500);
                        }
                        else appendHtmlMsg('ai', 'Hata: ' + (res.data.error || 'BaÄŸlantÄ± sorunu'));
                    }
                }
                el.sendBtn.disabled = false;
            }

            function initTurnstile(type) {
                if (!window.turnstile) {
                    setTimeout(() => initTurnstile(type), 100);
                    return;
                }

                if (state.turnstileWidgetId) window.turnstile.remove(state.turnstileWidgetId);
                const containerEl = document.getElementById(type === 'login' ? 'turnstileWrapLogin' : 'turnstileWrapReg');
                document.getElementById('turnstileWrapLogin').innerHTML = '';
                document.getElementById('turnstileWrapReg').innerHTML = '';

                state.tsToken = null;
                state.turnstileWidgetId = window.turnstile.render(containerEl, {
                    sitekey: CONFIG.TURNSTILE_SITE_KEY,
                    theme: 'dark',
                    callback: (t) => { state.tsToken = t; }
                });
            }

            async function handleLogin(e) {
                e.preventDefault();
                if (!state.tsToken) { showNotif("GÃ¼venlik doÄŸrulamasÄ±nÄ± tamamlayÄ±n", "error"); return; }

                const email = document.getElementById('loginEmail').value;
                const pass = document.getElementById('loginPass').value;
                const btn = document.getElementById('loginSubBtn');
                btn.disabled = true; btn.textContent = 'Bekleyin...';

                const res = await safeFetch('/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password: pass, turnstileToken: state.tsToken })
                });

                btn.disabled = false; btn.textContent = 'GiriÅŸ Yap';

                if (res.ok) {
                    loginSuccess(res.data.token, res.data.user);
                } else {
                    showNotif(res.data.error || 'GiriÅŸ yapÄ±lamadÄ±', 'error');
                    initTurnstile('login'); 
                }
            }

            async function handleRegister(e) {
                e.preventDefault();
                if (!state.tsToken) { showNotif("GÃ¼venlik doÄŸrulamasÄ±nÄ± tamamlayÄ±n", "error"); return; }

                const name = document.getElementById('regName').value;
                const email = document.getElementById('regEmail').value;
                const pass = document.getElementById('regPass').value;
                const btn = document.getElementById('regSubBtn');
                btn.disabled = true; btn.textContent = 'Bekleyin...';

                const res = await safeFetch('/register', {
                    method: 'POST',
                    body: JSON.stringify({ name, email, password: pass, turnstileToken: state.tsToken })
                });

                btn.disabled = false; btn.textContent = 'Hesap OluÅŸtur';

                if (res.ok) {
                    loginSuccess(res.data.token, res.data.user);
                } else {
                    showNotif(res.data.error || 'KayÄ±t baÅŸarÄ±sÄ±z', 'error');
                    initTurnstile('register'); 
                }
            }

            function loginSuccess(token, user) {
                __token = token;
                __user = user;
                state.isGuest = false;
                sessionStorage.setItem(STORAGE_KEY, token);
                sessionStorage.setItem(DATA_KEY, JSON.stringify(user));

                el.authOverlay.classList.remove('active');
                showNotif('HoÅŸgeldiniz!', 'success');
                initApp();
            }

            function logout() {
                __token = null; __user = null; state.isGuest = true;
                sessionStorage.removeItem(STORAGE_KEY);
                sessionStorage.removeItem(DATA_KEY);
                window.location.reload();
            }

            el.msgInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight < 150 ? this.scrollHeight : 150) + 'px';
                el.sendBtn.disabled = this.value.trim().length === 0;
            });

            el.msgInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!el.sendBtn.disabled) handleSend();
                }
            });

            el.sendBtn.onclick = handleSend;
            el.newChatBtn.onclick = () => { state.isGuest ? createLocalChat() : createRemoteChat(); };
            el.subNewChatBtn.onclick = () => {
                el.subOverlay.classList.remove('active');
                state.isGuest ? createLocalChat() : createRemoteChat();
            };
            el.menuToggleBtn.onclick = toggleSidebar;
            el.closeSidebarBtn.onclick = toggleSidebar;
            el.logoutBtn.onclick = logout;

            el.modelBtn.onclick = (e) => {
                e.stopPropagation();
                el.modelSelector.classList.toggle('open');
            };

            document.querySelectorAll('.model-option').forEach(opt => {
                opt.onclick = () => {
                    state.selectedModel = opt.dataset.model;
                    el.selectedModelTxt.textContent = opt.querySelector('.model-op-name').textContent;
                    document.querySelectorAll('.model-option').forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                    el.modelSelector.classList.remove('open');
                };
            });

            document.onclick = (e) => {
                if (!el.modelSelector.contains(e.target)) el.modelSelector.classList.remove('open');
            };

            el.userCardBtn.onclick = () => {
                if (state.isGuest) {
                    el.authOverlay.classList.add('active');
                    el.loginForm.style.display = 'block';
                    el.registerForm.style.display = 'none';
                    setTimeout(() => initTurnstile('login'), 150);
                } else {
                    el.subBtn.click();
                }
            };

            el.closeAuthBtn.onclick = () => el.authOverlay.classList.remove('active');

            document.getElementById('switchToRegLink').onclick = (e) => {
                e.preventDefault();
                el.loginForm.style.display = 'none';
                el.registerForm.style.display = 'block';
                setTimeout(() => initTurnstile('register'), 150);
            };

            document.getElementById('switchToLoginLink').onclick = (e) => {
                e.preventDefault();
                el.registerForm.style.display = 'none';
                el.loginForm.style.display = 'block';
                setTimeout(() => initTurnstile('login'), 150);
            };

            el.sidebarLoginBtn.onclick = () => {
                if (window.innerWidth <= 768) toggleSidebar();
                el.authOverlay.classList.add('active');
                el.loginForm.style.display = 'block';
                el.registerForm.style.display = 'none';
                setTimeout(() => initTurnstile('login'), 150);
            };

            el.closeLegalBtn.onclick = () => el.legalOverlay.classList.remove('active');

            el.settingsBtn.onclick = async (e) => {
                e.stopPropagation();
                if (window.innerWidth <= 768) toggleSidebar();
                el.settingsOverlay.classList.add('active');
                el.sysPromptInput.value = 'YÃ¼kleniyor...';
                const sysPromptCount = document.getElementById('sysPromptCount');
                sysPromptCount.textContent = `... / 600`;
                const res = await safeFetch('/personalization');
                el.sysPromptInput.value = res.ok ? res.data.systemPrompt : '';
                sysPromptCount.textContent = `${el.sysPromptInput.value.length} / 600`;
            };
            el.closeSettingsBtn.onclick = () => el.settingsOverlay.classList.remove('active');

            el.sysPromptInput.addEventListener('input', (e) => {
                const sysPromptCount = document.getElementById('sysPromptCount');
                sysPromptCount.textContent = `${e.target.value.length} / 600`;
            });

            document.querySelectorAll('.personalization-example-item').forEach(item => {
                item.onclick = () => {
                    const txt = item.getAttribute('data-text');
                    if (el.sysPromptInput.value) {
                        el.sysPromptInput.value += ' ' + txt;
                    } else {
                        el.sysPromptInput.value = txt;
                    }
                    if (el.sysPromptInput.value.length > 600) {
                        el.sysPromptInput.value = el.sysPromptInput.value.substring(0, 600);
                    }
                    const sysPromptCount = document.getElementById('sysPromptCount');
                    sysPromptCount.textContent = `${el.sysPromptInput.value.length} / 600`;
                };
            });

            document.getElementById('clearSettingsBtn').onclick = () => {
                el.sysPromptInput.value = '';
                const sysPromptCount = document.getElementById('sysPromptCount');
                sysPromptCount.textContent = `0 / 600`;
            };

            el.settingsForm.onsubmit = async (e) => {
                e.preventDefault();
                el.saveSettingsBtn.disabled = true;
                el.saveSettingsBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Kaydediliyor...';
                const txt = el.sysPromptInput.value;
                const res = await safeFetch('/personalization', { method: 'POST', body: JSON.stringify({ systemPrompt: txt }) });
                if (res.ok) showNotif('KiÅŸiselleÅŸtirme ayarlarÄ± kaydedildi.', 'success');
                else showNotif('Kaydedilemedi: ' + (res.data.error || 'Bilinmeyen hata'), 'error');
                el.saveSettingsBtn.disabled = false;
                el.saveSettingsBtn.innerHTML = '<i class="fas fa-save"></i> Kaydet';
                el.settingsOverlay.classList.remove('active');
            };

            el.subBtn.onclick = async (e) => {
                e.stopPropagation();
                if (window.innerWidth <= 768) toggleSidebar();
                el.subOverlay.classList.add('active');
                el.subDetails.textContent = 'Abonelik bilgileri yÃ¼kleniyor...';
                el.accountNameInfo.textContent = __user ? __user.name : '-';
                el.accountEmailInfo.textContent = __user ? __user.email : '-';

                const res = await safeFetch(`/subscription?chatId=${state.currentChatId}`);
                if (res.ok) {
                    const data = res.data;
                    const isPlus = data.isSubscribed || state.isPremium;
                    el.subPlanName.textContent = isPlus ? 'Premium Plan (Aktif)' : 'Ãœcretsiz Plan';
                    el.subPlanName.style.color = isPlus ? 'var(--primary)' : 'var(--text-main)';

                    if (isPlus) {
                        el.subDetails.textContent = 'Premium Ã¶zelliklerin keyfini Ã§Ä±karÄ±n! SÄ±nÄ±rsÄ±z mesaj hakkÄ±na sahipsiniz.';
                        el.subProgressFill.style.width = '100%';
                        el.subProgressFill.style.background = 'var(--primary)';
                        el.subUsageText.textContent = 'SÄ±nÄ±rsÄ±z KullanÄ±m';
                        el.upgradeBtn.style.display = 'none';
                        el.subNewChatBtn.style.display = 'none';
                        el.msgInput.disabled = false;
                        el.msgInput.placeholder = 'Marul AI ile mesajlaÅŸÄ±n...';
                    } else {
                        const used = data.messageCount || 0;
                        const limit = data.limit || 25;
                        const pct = Math.min((used / limit) * 100, 100);
                        el.subDetails.textContent = `Bu sohbette ${limit} mesaj hakkÄ±nÄ±z bulunmaktadÄ±r.`;
                        el.subProgressFill.style.width = pct + '%';
                        el.subProgressFill.style.background = pct >= 100 ? 'var(--danger)' : 'var(--primary)';
                        el.subUsageText.textContent = `${used} / ${limit} Mesaj KullanÄ±ldÄ± (Bu Sohbet)`;
                        el.upgradeBtn.style.display = 'block';
                        el.upgradeBtn.onclick = () => {
                            showNotif('Platformumuza mobil uygulamamÄ±z Ã¼zerinden devam edip Ã¶zellikleri satÄ±n alabilirsiniz!', 'info');
                        };

                        if (pct >= 100) {
                            el.subNewChatBtn.style.display = 'block';
                            el.msgInput.disabled = true;
                            el.sendBtn.disabled = true;
                            el.msgInput.placeholder = 'Bu sohbetteki mesaj limitiniz doldu.';
                        } else {
                            el.subNewChatBtn.style.display = 'none';
                            el.msgInput.disabled = false;
                            el.msgInput.placeholder = 'Marul AI ile mesajlaÅŸÄ±n...';
                        }
                    }
                } else {
                    el.subDetails.textContent = 'Abonelik durumu alÄ±namadÄ±.';
                }
            };
            el.closeSubBtn.onclick = () => el.subOverlay.classList.remove('active');

            el.loginForm.onsubmit = handleLogin;
            el.registerForm.onsubmit = handleRegister;

            initApp();

        })();
    </script>
</body>

</html>
