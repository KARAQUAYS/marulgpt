<!DOCTYPE html>
<html lang="tr" data-theme="dark">

<head>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#22c55e">

    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <meta name="description"
        content="Marul AI, günlük işlerinizi kolaylaştıran güçlü bir yapay zekâ asistanı. Soru sorun, fikir isteyin, kod yazdırın, hesap yaptırın—Marul AI her zaman hazır!">

    <title>Marul AI - Akıllı Sohbet Asistanı</title>

    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit" async defer></script>

    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="favicon.png">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Marul AI",
      "url": "https://marulai.com.tr",
      "logo": "https://marulai.com.tr/favicon.png"
    }
    </script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9887645562823181"
        crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V0TG9J2D9C"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-V0TG9J2D9C');
    </script>

    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-deep: #030305;
            --bg-dark: #0d0d12;
            --bg-card: #15151c;
            --bg-card-hover: #1e1e28;
            --border-light: rgba(255, 255, 255, 0.05);
            --border-medium: rgba(255, 255, 255, 0.1);

            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --text-xs: #6b7280;

            --primary: #00ff9d;
            --primary-hover: #00cc7d;
            --primary-glow: rgba(0, 255, 157, 0.2);
            --secondary: #7000ff;
            --secondary-glow: rgba(112, 0, 255, 0.2);
            --danger: #ef4444;
            --danger-hover: #dc2626;

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 18px;
            --radius-xl: 24px;

            --sidebar-w: 280px;
            --anim-snappy: 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            --anim-smooth: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            height: 100vh;
            height: 100dvh;
            height: -webkit-fill-available;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            height: 100vh;
            height: 100dvh;
            height: -webkit-fill-available;
            height: var(--app-height, 100dvh);
            display: flex;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            user-select: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            outline: none;
            border: none;
            user-select: none;
        }

        input,
        textarea {
            font-family: inherit;
            outline: none;
            user-select: text;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            padding: 16px 20px;
            border-radius: var(--radius-md);
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            color: var(--text-main);
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(120%);
            transition: transform var(--anim-snappy);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification i {
            font-size: 1.2rem;
        }

        .notification.success i {
            color: var(--primary);
        }

        .notification.error i {
            color: var(--danger);
        }

        .notification.info i {
            color: #3b82f6;
        }

        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .sidebar {
            width: var(--sidebar-w);
            height: 100%;
            background: var(--bg-dark);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            transition: margin-left var(--anim-snappy);
            z-index: 100;
            flex-shrink: 0;
        }

        .sidebar.collapsed {
            margin-left: calc(-1 * var(--sidebar-w));
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand img {
            width: 34px;
            height: 34px;
            filter: drop-shadow(0 0 8px var(--primary-glow));
        }

        .brand span {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .new-chat-btn {
            margin: 15px 20px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            color: var(--text-main);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--anim-snappy);
        }

        .new-chat-btn:hover {
            background: var(--bg-card-hover);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 10px;
        }

        .history-item {
            padding: 12px 14px;
            margin-bottom: 6px;
            border-radius: var(--radius-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--anim-snappy);
            color: var(--text-muted);
        }

        .history-item:hover {
            background: var(--bg-card);
            color: var(--text-main);
        }

        .history-item.active {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-main);
            font-weight: 500;
        }

        .history-info {
            flex: 1;
            overflow: hidden;
        }

        .history-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9rem;
        }

        .history-date {
            font-size: 0.75rem;
            color: #3b82f6;
            margin-top: 4px;
        }

        .history-actions {
            display: none;
            gap: 8px;
        }

        .history-item:hover .history-actions {
            display: flex;
        }

        .history-actions button {
            background: none;
            color: var(--text-muted);
            padding: 4px;
            transition: color 0.2s;
        }

        .history-actions button:hover {
            color: var(--danger);
        }

        .sidebar-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-light);
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--anim-snappy);
            border: 1px solid transparent;
        }

        .user-card:hover {
            border-color: var(--border-medium);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .user-details {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            font-size: 0.75rem;
            color: var(--primary);
            margin-top: 2px;
        }

        .user-status.free {
            color: #ff9f43;
        }

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: var(--bg-deep);
            overflow: hidden;
            min-height: 0;
            height: 100%;
        }

        .top-nav {
            height: 56px;
            min-height: 56px;
            padding: 0 20px;
            padding-top: env(safe-area-inset-top, 0px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-light);
            background: rgba(3, 3, 5, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            position: relative;
            width: 100%;
            z-index: 10;
            flex-shrink: 0;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-toggle {
            background: none;
            color: var(--text-main);
            font-size: 1.2rem;
            padding: 8px;
            border-radius: 8px;
            transition: 0.2s;
        }

        .menu-toggle:hover {
            background: var(--bg-card);
        }

        .chat-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .model-selector {
            position: relative;
        }

        .model-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-medium);
            color: var(--text-main);
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--anim-snappy);
        }

        .model-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .app-download-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-medium);
            color: var(--text-main);
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--anim-snappy);
            text-decoration: none;
        }

        .app-download-btn i {
            color: #00ff9d;
        }

        .app-download-btn:hover {
            background: rgba(0, 255, 157, 0.1);
            border-color: #00ff9d;
            transform: translateY(-1px);
        }

        .model-dropdown {
            position: absolute;
            top: 120%;
            right: 0;
            width: 220px;
            background: var(--bg-dark);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            padding: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--anim-snappy);
            z-index: 20;
        }

        .model-selector.open .model-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .model-option {
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: 0.2s;
        }

        .model-option:hover {
            background: var(--bg-card);
        }

        .model-option.active {
            background: rgba(0, 255, 157, 0.1);
            border-left: 2px solid var(--primary);
        }

        .model-op-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .model-op-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .top-btn {
            background: none;
            color: var(--text-muted);
            font-size: 1.1rem;
            transition: 0.2s;
            padding: 8px;
        }

        .top-btn:hover {
            color: var(--text-main);
        }

        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .legal-links {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-light);
        }

        .legal-links a {
            font-size: 0.75rem;
            color: var(--text-muted);
            transition: 0.2s;
        }

        .legal-links a:hover {
            color: var(--text-main);
        }

        .messages-wrapper {
            flex: 1;
            padding: 16px 0 0 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 0;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            max-width: 500px;
            padding: 20px;
        }

        .welcome-screen img {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 20px var(--primary-glow));
        }

        .welcome-screen h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #fff, #9ca3af);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-screen p {
            color: var(--text-muted);
            font-size: 1rem;
            line-height: 1.5;
        }

        .message {
            width: 100%;
            max-width: 800px;
            padding: 10px 20px;
            margin: 10px 0;
            display: flex;
            gap: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-weight: 600;
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .message.user .message-avatar {
            display: none;
        }

        .message-content {
            flex: 1;
            max-width: calc(100% - 60px);
            user-select: text;
        }

        .message.user .message-content {
            flex: 0 1 auto;
            align-self: flex-end;
            background: #2a2a2a;
            padding: 12px 18px;
            border-radius: var(--radius-lg) 4px var(--radius-lg) var(--radius-lg);
            font-size: 0.95rem;
            line-height: 1.5;
            border: none;
            max-width: 80%;
        }

        .message.ai .message-content {
            background: transparent;
            padding: 5px 0;
            font-size: 0.95rem;
            line-height: 1.5;
            border: none;
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--text-xs);
            margin-top: 8px;
            text-align: right;
        }

        .message.user .message-time {
            text-align: left;
        }

        .markdown-body {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-main);
            max-width: 100%;
            user-select: text;
        }

        .code-block-wrapper {
            margin: 1rem 0;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--border-light);
            background: #0d0d11;
            width: fit-content;
            max-width: 100%;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1a1a22;
            padding: 8px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .code-lang {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.8rem;
            color: #8b9bb4;
            font-weight: 600;
            text-transform: lowercase;
        }

        .message-content pre {
            margin: 0;
            padding: 1.2rem;
            background: #0d0d11 !important;
            border: none;
            border-radius: 0;
            overflow-x: auto;
            max-width: 100%;
            word-wrap: normal;
        }

        .message-content pre code {
            background: none;
            padding: 0;
            border-radius: 0;
            font-size: 0.85rem;
            line-height: 1.5;
            color: #e6edf3 !important;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: #fff;
            padding: 5px 14px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            white-space: nowrap;
        }

        .copy-btn:hover {
            border-color: #00ff9d;
            background: rgba(0, 255, 157, 0.08);
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.1);
            color: #fff;
        }

        .code-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .markdown-body p {
            margin-bottom: 1em;
        }

        .markdown-body p:last-child {
            margin-bottom: 0;
        }

        .markdown-body code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
        }

        .markdown-body pre {
            background: var(--bg-dark);
            padding: 15px;
            border-radius: var(--radius-md);
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid var(--border-light);
        }

        .markdown-body pre code {
            background: none;
            padding: 0;
            color: inherit;
            border-radius: 0;
        }

        .markdown-body ul,
        .markdown-body ol {
            margin-bottom: 1em;
            padding-left: 20px;
        }

        .code-block-wrapper {
            position: relative;
            margin: 15px 0;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .code-block-wrapper pre {
            margin: 0;
            border: none;
            border-radius: 0;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid var(--border-light);
        }

        .code-lang {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
        }

        .code-actions button {
            background: none;
            color: var(--text-muted);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
        }

        .code-actions button:hover {
            color: var(--text-main);
        }

        .input-area {
            position: relative;
            width: 100%;
            background: var(--bg-deep);
            padding: 12px 20px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
            border-top: 1px solid var(--border-light);
        }

        .input-container {
            width: 100%;
            max-width: 800px;
            position: relative;
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-xl);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            display: flex;
            padding: 6px;
            transition: border-color var(--anim-snappy);
        }

        .input-container:focus-within {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .message-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-main);
            padding: 12px 15px;
            font-size: 1rem;
            resize: none;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .message-input::placeholder {
            color: var(--text-muted);
        }

        .input-actions {
            display: flex;
            align-items: flex-end;
            padding: 5px;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--text-main);
            color: var(--bg-deep);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: var(--anim-snappy);
        }

        .send-btn:hover {
            transform: scale(1.05);
            background: var(--primary);
            color: #000;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: var(--text-muted);
        }

        .input-footer {
            margin-top: 8px;
            font-size: 0.7rem;
            color: var(--text-xs);
            text-align: center;
        }

        .typing {
            display: none;
            padding: 20px;
        }

        .typing span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--text-muted);
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--anim-snappy);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-dark);
            width: 100%;
            max-width: 420px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: var(--anim-snappy);
            overflow: hidden;
            display: none;
        }

        .modal-overlay.active .modal {
            display: block;
            transform: scale(1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .modal-close {
            background: none;
            color: var(--text-muted);
            font-size: 1.2rem;
        }

        .modal-close:hover {
            color: var(--text-main);
        }

        .modal-body {
            padding: 24px 20px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-light);
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            transition: 0.2s;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            color: var(--text-main);
            font-size: 0.95rem;
            transition: 0.2s;
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 255, 157, 0.1);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: var(--anim-snappy);
        }

        .btn-primary {
            background: var(--primary);
            color: #000;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-main);
            border: 1px solid var(--border-medium);
        }

        .btn-secondary:hover {
            background: var(--border-medium);
        }

        #turnstileWrap {
            margin: 15px 0;
            display: flex;
            justify-content: center;
            min-height: 65px;
        }

        .personalization-examples {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .personalization-examples-title {
            width: 100%;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .personalization-example-item {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-medium);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--anim-snappy);
        }

        .personalization-example-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .char-counter {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: right;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .app-download-btn span {
                display: none;
            }

            .app-download-btn {
                padding: 8px;
                border-radius: var(--radius-sm);
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: var(--sidebar-w);
                height: 100%;
                height: 100dvh;
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
                margin-left: 0;
                z-index: 1000;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
                box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
            }

            .sidebar.collapsed {
                margin-left: 0;
                transform: translateX(-100%);
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .sidebar.mobile-open~.sidebar-overlay {
                display: block;
            }

            .main-area {
                width: 100%;
                height: 100%;
            }

            .top-nav {
                height: 50px;
                min-height: 50px;
                padding: 0 12px;
                padding-top: env(safe-area-inset-top, 0px);
            }

            .chat-title {
                font-size: 0.9rem;
                max-width: 120px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .nav-right {
                gap: 8px;
            }

            .model-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
                gap: 6px;
            }

            .model-dropdown {
                right: -10px;
                width: 200px;
            }

            .messages-wrapper {
                padding: 12px 0 0 0;
            }

            .message {
                padding: 8px 12px;
                gap: 12px;
            }

            .message-avatar {
                width: 30px;
                height: 30px;
                font-size: 0.8rem;
            }

            .message-content {
                max-width: calc(100% - 42px);
            }

            .message.user .message-content {
                max-width: 85%;
                padding: 10px 14px;
                font-size: 0.9rem;
            }

            .message.ai .message-content {
                font-size: 0.9rem;
            }

            .markdown-body {
                font-size: 0.9rem;
            }

            .input-area {
                padding: 8px 10px;
                padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
            }

            .input-container {
                border-radius: var(--radius-lg);
                padding: 4px;
            }

            .message-input {
                padding: 10px 12px;
                font-size: 0.95rem;
                max-height: 100px;
            }

            .send-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .input-footer {
                font-size: 0.65rem;
                margin-top: 6px;
            }

            .welcome-screen {
                padding: 15px;
            }

            .welcome-screen img {
                width: 60px;
                height: 60px;
                margin-bottom: 15px;
            }

            .welcome-screen h1 {
                font-size: 1.4rem;
            }

            .welcome-screen p {
                font-size: 0.9rem;
            }

            .modal {
                max-width: 95vw;
                margin: 10px;
                max-height: 90vh;
                max-height: 90dvh;
            }

            .modal-body {
                padding: 16px;
                max-height: 70vh;
                max-height: 70dvh;
                overflow-y: auto;
            }

            .code-block-wrapper {
                font-size: 0.8rem;
            }

            .message-content pre {
                padding: 0.8rem;
            }

            .message-content pre code {
                font-size: 0.75rem;
            }

            .notification {
                top: 10px;
                right: 10px;
                left: 10px;
                font-size: 0.85rem;
                padding: 12px 16px;
            }

            .sidebar-footer {
                padding: 12px 15px;
                padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
            }

            .new-chat-btn {
                margin: 10px 15px;
                padding: 10px 14px;
                font-size: 0.85rem;
            }

            .history-item {
                padding: 10px 12px;
            }

            .history-title {
                font-size: 0.85rem;
            }

            .history-actions {
                display: flex;
                opacity: 0.6;
            }
        }

        @media (max-width: 380px) {
            .top-nav {
                height: 46px;
                min-height: 46px;
                padding: 0 8px;
            }

            .chat-title {
                font-size: 0.8rem;
                max-width: 90px;
            }

            .model-btn {
                padding: 5px 8px;
                font-size: 0.75rem;
            }

            .welcome-screen h1 {
                font-size: 1.2rem;
            }

            .welcome-screen p {
                font-size: 0.8rem;
            }

            .message {
                padding: 6px 8px;
                gap: 8px;
            }

            .message-avatar {
                width: 26px;
                height: 26px;
            }

            .message.user .message-content {
                max-width: 90%;
                font-size: 0.85rem;
            }

            .input-area {
                padding: 6px 8px;
                padding-bottom: calc(6px + env(safe-area-inset-bottom, 0px));
            }

            .message-input {
                padding: 8px 10px;
                font-size: 0.9rem;
            }

            .send-btn {
                width: 34px;
                height: 34px;
            }

            .input-footer {
                display: none;
            }
        }

        @media (max-height: 500px) and (max-width: 768px) {
            .top-nav {
                height: 40px;
                min-height: 40px;
            }

            .input-area {
                padding: 4px 8px;
                padding-bottom: calc(4px + env(safe-area-inset-bottom, 0px));
            }

            .input-footer {
                display: none;
            }

            .welcome-screen {
                padding: 10px;
            }

            .welcome-screen img {
                width: 40px;
                height: 40px;
            }

            .welcome-screen h1 {
                font-size: 1.1rem;
            }
        }
    </style>
</head>

<body>

    <div id="notification" class="notification">
        <i class="fas fa-info-circle"></i>
        <span id="notifMsg"></span>
    </div>

    <div class="app-container">

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <img src="favicon.png" alt="Marul AI">
                    <span>Marul AI</span>
                </div>
                <button class="top-btn" id="closeSidebarBtn" style="display: none;"><i
                        class="fas fa-times"></i></button>
            </div>

            <button class="new-chat-btn" id="newChatBtn">
                <i class="fas fa-plus"></i> Yeni Sohbet
            </button>

            <div class="chat-list" id="chatList">
            </div>

            <div class="sidebar-footer">
                <div class="user-card" id="userCardBtn"
                    style="display:none; flex-direction:column; align-items:flex-start; gap:10px;">
                    <div style="display:flex; align-items:center; gap:10px; width:100%;">
                        <div class="user-avatar" id="userAvatar">M</div>
                        <div class="user-details" style="flex:1;">
                            <div class="user-name" id="userNameTxt">Misafir</div>
                            <div class="user-status free" id="userStatusTxt">Giriş Yapılmadı</div>
                        </div>
                    </div>
                    <div
                        style="display:flex; flex-direction:column; gap:5px; width:100%; border-top: 1px solid var(--border-light); margin-top: 5px; padding-top: 10px;">
                        <button class="btn btn-secondary" id="settingsBtn"
                            style="padding: 8px; font-size: 0.8rem; justify-content: flex-start;"><i
                                class="fas fa-cog"></i> Ayarlar & Davranış</button>
                        <button class="btn btn-secondary" id="subBtn"
                            style="padding: 8px; font-size: 0.8rem; justify-content: flex-start;"><i
                                class="fas fa-gem"></i> Abonelik Durumu</button>
                    </div>
                </div>

                <div class="auth-buttons" id="sidebarAuthBtns">
                    <button class="btn btn-primary" id="sidebarLoginBtn">Giriş Yap</button>
                </div>

                <div class="legal-links">
                    <a href="#" onclick="showAbout(); return false;">Hakkımızda</a>
                    <a href="#" onclick="showPrivacy(); return false;">Gizlilik</a>
                    <a href="#" onclick="showKVKK(); return false;">KVKK</a>
                    <a href="#" onclick="showContact(); return false;">İletişim</a>
                </div>
            </div>
        </aside>

        <main class="main-area">

            <nav class="top-nav">
                <div class="nav-left">
                    <button class="menu-toggle" id="menuToggleBtn"><i class="fas fa-bars"></i></button>
                    <div class="chat-title" id="chatTitleTxt">Yeni Sohbet</div>
                </div>
                <div class="nav-right">
                    <a href="https://play.google.com/store/apps/details?id=ai.marul.com" target="_blank"
                        class="app-download-btn" title="Mobil Uygulamamızı İndirin">
                        <i class="fab fa-google-play"></i> <span>Uygulamayı İndir</span>
                    </a>
                    <div class="model-selector" id="modelSelector">
                        <button class="model-btn" id="modelBtn">
                            <span id="selectedModelTxt">Marul V7</span> <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="model-dropdown">
                            <div class="model-option active" data-model="marul">
                                <div class="model-op-name">Marul V7</div>
                                <div class="model-op-desc">Yerli ve milli modelimiz</div>
                            </div>
                            <div class="model-option" data-model="llama">
                                <div class="model-op-name">Llama 3 (70B)</div>
                                <div class="model-op-desc">Açık kaynak devi</div>
                            </div>
                        </div>
                    </div>
                    <button class="top-btn" id="logoutBtn" title="Çıkış Yap" style="display: none;"><i
                            class="fas fa-sign-out-alt"></i></button>
                </div>
            </nav>

            <div class="messages-wrapper" id="msgContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <img src="favicon.png" alt="Marul AI">
                    <h1>Nasıl yardımcı olabilirim?</h1>
                    <p>Sorularınızı yanıtlamak, analiz yapmak veya kod yazmak için buradayım.</p>
                </div>
                <div class="typing" id="typingInd"><span></span><span></span><span></span></div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <textarea id="msgInput" class="message-input" rows="1" placeholder="Marul AI'ye mesaj gönder..."
                        autofocus></textarea>
                    <div class="input-actions">
                        <button class="send-btn" id="sendBtn" disabled><i class="fas fa-arrow-up"></i></button>
                    </div>
                </div>
                <div class="input-footer">Marul AI hata yapabilir. Önemli bilgileri doğrulayın.</div>
            </div>

        </main>
    </div>

    <div class="modal-overlay" id="authOverlay">
        <div class="modal" id="authModal">
            <div class="modal-header">
                <div class="modal-title">Hesabınıza Erişin</div>
                <button class="modal-close" id="closeAuthBtn"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">

                <form id="loginForm">
                    <p style="color:var(--text-muted); font-size: 0.9rem; margin-bottom:20px; text-align:center;">Marul
                        AI hesabınıza giriş yaparak sohbete devam edin</p>
                    <div class="form-group">
                        <label class="form-label" style="font-weight: 500;">E-posta Adresi</label>
                        <input type="email" class="form-control" id="loginEmail" placeholder="ornek@mail.com"
                            style="padding: 12px; font-size: 1rem;" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 25px;">
                        <label class="form-label" style="font-weight: 500;">Şifre</label>
                        <input type="password" class="form-control" id="loginPass" placeholder="••••••••"
                            style="padding: 12px; font-size: 1rem;" required>
                    </div>
                    <div id="turnstileWrapLogin" class="turnstile-container"
                        style="min-height: 65px; margin-bottom: 20px; display:flex; justify-content:center;"></div>
                    <button type="submit" class="btn btn-primary" id="loginSubBtn"
                        style="width: 100%; padding: 12px; font-size: 1rem; font-weight: 600;">Giriş Yap</button>

                    <div style="text-align:center; margin-top: 25px; font-size: 0.9rem; color: var(--text-muted);">
                        Hesabınız yok mu? <a href="#" id="switchToRegLink"
                            style="color: var(--primary); font-weight: 600; text-decoration: none;">Hemen Kayıt Olun</a>
                    </div>
                </form>

                <form id="registerForm" style="display: none;">
                    <p style="color:var(--text-muted); font-size: 0.9rem; margin-bottom:20px; text-align:center;">
                        Hızlıca hesap oluşturun ve kullanmaya başlayın</p>
                    <div class="form-group">
                        <label class="form-label" style="font-weight: 500;">Ad Soyad</label>
                        <input type="text" class="form-control" id="regName" placeholder="Adınız Soyadınız"
                            style="padding: 12px; font-size: 1rem;" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="font-weight: 500;">E-posta Adresi</label>
                        <input type="email" class="form-control" id="regEmail" placeholder="ornek@mail.com"
                            style="padding: 12px; font-size: 1rem;" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label" style="font-weight: 500;">Şifre</label>
                        <input type="password" class="form-control" id="regPass" placeholder="En az 6 karakter"
                            style="padding: 12px; font-size: 1rem;" required>
                    </div>
                    <div id="turnstileWrapReg" class="turnstile-container"
                        style="min-height: 65px; margin-bottom: 15px; display:flex; justify-content:center;"></div>

                    <p
                        style="font-size:0.8rem; color:var(--text-muted); margin-bottom:20px; text-align:center; line-height: 1.5;">
                        Hesap oluşturarak
                        <a href="#" onclick="showTerms(); return false;"
                            style="color:var(--primary); font-weight: 500;">Kullanıcı Sözleşmesi</a>'ni ve
                        <a href="#" onclick="showKVKK(); return false;"
                            style="color:var(--primary); font-weight: 500;">KVKK Aydınlatma Metni</a>'ni kabul etmiş
                        olursunuz.
                    </p>
                    <button type="submit" class="btn btn-primary" id="regSubBtn"
                        style="width: 100%; padding: 12px; font-size: 1rem; font-weight: 600;">Hesap Oluştur</button>

                    <div style="text-align:center; margin-top: 25px; font-size: 0.9rem; color: var(--text-muted);">
                        Zaten hesabınız var mı? <a href="#" id="switchToLoginLink"
                            style="color: var(--primary); font-weight: 600; text-decoration: none;">Giriş Yapın</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsOverlay">
        <div class="modal" id="settingsModal">
            <div class="modal-header">
                <div class="modal-title">Kişiselleştirme Ayarları</div>
                <button class="modal-close" id="closeSettingsBtn"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:15px;"><i
                        class="fas fa-wand-magic-sparkles" style="color:var(--primary); margin-right:5px;"></i> Marul
                    AI'ye size nasıl yanıt
                    vermesi gerektiğini söyleyin. Özelleştirilmiş talimatlar genel sorulara verilen yanıtları
                    etkileyecektir.</p>
                <form id="settingsForm">
                    <div class="form-group">
                        <label class="form-label">Sistem Talimatları</label>
                        <textarea class="form-control" id="sysPromptInput" rows="4"
                            placeholder="Örn: Bana hep sen diye hitap et ve yanıtlarını olabildiğince kısa tut..."
                            maxlength="600"></textarea>
                        <div class="char-counter" id="sysPromptCount">0 / 600</div>
                    </div>

                    <div class="personalization-examples">
                        <div class="personalization-examples-title">
                            <i class="fas fa-lightbulb"></i> Örnek talimatlar
                        </div>
                        <span class="personalization-example-item" data-text="Samimi ve arkadaşça konuş">Samimi
                            konuş</span>
                        <span class="personalization-example-item" data-text="Kısa ve öz cevaplar ver">Kısa
                            cevaplar</span>
                        <span class="personalization-example-item" data-text="Detaylı ve açıklayıcı ol">Detaylı
                            açıkla</span>
                        <span class="personalization-example-item" data-text="Bol emoji kullan 😊">Bol emoji</span>
                        <span class="personalization-example-item" data-text="Resmi ve profesyonel ol">Profesyonel
                            ol</span>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" id="clearSettingsBtn" style="flex:1;"><i
                                class="fas fa-eraser"></i> Temizle</button>
                        <button type="submit" class="btn btn-primary" id="saveSettingsBtn" style="flex:2;"><i
                                class="fas fa-save"></i> Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="subOverlay">
        <div class="modal" id="subModal">
            <div class="modal-header">
                <div class="modal-title">Hesap & Abonelik Durumu</div>
                <button class="modal-close" id="closeSubBtn"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;"><i
                            class="fas fa-crown"></i>
                    </div>
                    <h3 id="subPlanName" style="margin-bottom: 5px;">Ücretsiz Plan</h3>
                    <p id="subDetails" style="color:var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
                        Bu sohbette 25 mesaj hakkınız bulunmaktadır.
                    </p>
                    <div id="subProgressBar"
                        style="width:100%; height:8px; background:var(--bg-card); border-radius:4px; margin-bottom:8px; overflow:hidden; border:1px solid var(--border-medium);">
                        <div id="subProgressFill"
                            style="width:0%; height:100%; background:var(--primary); transition:width 0.3s;"></div>
                    </div>
                    <p id="subUsageText" style="font-size:0.8rem; color:var(--text-muted); margin-bottom: 15px;">0 / 25
                        Mesaj Kullanıldı (Bu Sohbet)</p>

                    <button class="btn btn-primary" id="upgradeBtn"
                        style="display:none; margin: 0 auto; max-width: 250px;">
                        <i class="fas fa-gem"></i> Marul AI Plus'a Geç
                    </button>

                    <button class="btn btn-secondary" id="subNewChatBtn"
                        style="display:none; margin: 10px auto 0 auto; max-width: 250px;">
                        <i class="fas fa-plus"></i> Yeni Sohbet Başlat
                    </button>
                </div>

                <div style="border-top: 1px solid var(--border-light); padding-top: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: var(--text-main); font-size: 1rem;">Hesap Bilgileri</h4>
                    <div style="display: grid; gap: 10px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(128, 128, 128, 0.05); border-radius: var(--radius-sm); border: 1px solid var(--border-light);">
                            <span style="color: var(--text-muted); font-size: 0.9rem;">İsim</span>
                            <span id="accountNameInfo"
                                style="font-weight: 600; color: var(--text-main); font-size: 0.95rem;">-</span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(128, 128, 128, 0.05); border-radius: var(--radius-sm); border: 1px solid var(--border-light);">
                            <span style="color: var(--text-muted); font-size: 0.9rem;">E-posta</span>
                            <span id="accountEmailInfo"
                                style="font-weight: 600; color: var(--text-main); font-size: 0.95rem;">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="legalOverlay">
        <div class="modal" id="legalModal">
            <div class="modal-header">
                <div class="modal-title" id="legalTitle">Bilgi</div>
                <button class="modal-close" id="closeLegalBtn"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="legalContent" style="color:var(--text-muted); line-height:1.6; font-size:0.95rem;"></div>
                <button class="btn btn-secondary" style="margin-top: 20px;"
                    onclick="document.getElementById('legalOverlay').classList.remove('active');">Anladım</button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const CONFIG = {
                BACKEND_URL: 'https://marulgpt-backend.marulgpt.workers.dev',
                TURNSTILE_SITE_KEY: '0x4AAAAAACIwky-WL9EDj91G'
            };

            const STORAGE_KEY = btoa('marul_s_token');
            const DATA_KEY = btoa('marul_s_user');

            if (sessionStorage.getItem(STORAGE_KEY)) {
                localStorage.setItem(STORAGE_KEY, sessionStorage.getItem(STORAGE_KEY));
                if (sessionStorage.getItem(DATA_KEY)) localStorage.setItem(DATA_KEY, sessionStorage.getItem(DATA_KEY));
                sessionStorage.removeItem(STORAGE_KEY);
                sessionStorage.removeItem(DATA_KEY);
            }

            function isTokenExpired(token) {
                try {
                    const parts = token.split('.');
                    if (parts.length !== 3) return true;
                    const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                    if (payload.exp && payload.exp < Math.floor(Date.now() / 1000)) return true;
                    return false;
                } catch (e) { return true; }
            }

            let __token = localStorage.getItem(STORAGE_KEY) || null;
            if (__token && isTokenExpired(__token)) {
                __token = null;
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(DATA_KEY);
            }
            let __user = JSON.parse(localStorage.getItem(DATA_KEY) || 'null');

            let state = {
                isGuest: !__token,
                guestQuestionsLeft: parseInt(localStorage.getItem('guest_left') || '10'),
                currentChatId: 'new',
                chats: [],
                guestChats: JSON.parse(localStorage.getItem('g_chats') || '[]'),
                selectedModel: 'marul',
                turnstileWidgetId: null,
                tsToken: null
            };

            const el = {
                msgInput: document.getElementById('msgInput'),
                sendBtn: document.getElementById('sendBtn'),
                msgContainer: document.getElementById('msgContainer'),
                welcomeScreen: document.getElementById('welcomeScreen'),
                typingInd: document.getElementById('typingInd'),
                chatList: document.getElementById('chatList'),
                newChatBtn: document.getElementById('newChatBtn'),
                chatTitleTxt: document.getElementById('chatTitleTxt'),

                userCardBtn: document.getElementById('userCardBtn'),
                userNameTxt: document.getElementById('userNameTxt'),
                userStatusTxt: document.getElementById('userStatusTxt'),
                userAvatar: document.getElementById('userAvatar'),
                logoutBtn: document.getElementById('logoutBtn'),

                menuToggleBtn: document.getElementById('menuToggleBtn'),
                sidebar: document.getElementById('sidebar'),
                closeSidebarBtn: document.getElementById('closeSidebarBtn'),

                modelBtn: document.getElementById('modelBtn'),
                modelSelector: document.getElementById('modelSelector'),
                selectedModelTxt: document.getElementById('selectedModelTxt'),

                authOverlay: document.getElementById('authOverlay'),
                closeAuthBtn: document.getElementById('closeAuthBtn'),
                loginForm: document.getElementById('loginForm'),
                registerForm: document.getElementById('registerForm'),

                settingsBtn: document.getElementById('settingsBtn'),
                subBtn: document.getElementById('subBtn'),
                sidebarAuthBtns: document.getElementById('sidebarAuthBtns'),
                sidebarLoginBtn: document.getElementById('sidebarLoginBtn'),

                settingsOverlay: document.getElementById('settingsOverlay'),
                closeSettingsBtn: document.getElementById('closeSettingsBtn'),
                settingsForm: document.getElementById('settingsForm'),
                sysPromptInput: document.getElementById('sysPromptInput'),
                saveSettingsBtn: document.getElementById('saveSettingsBtn'),

                subOverlay: document.getElementById('subOverlay'),
                closeSubBtn: document.getElementById('closeSubBtn'),
                subPlanName: document.getElementById('subPlanName'),
                subDetails: document.getElementById('subDetails'),
                subProgressFill: document.getElementById('subProgressFill'),
                subUsageText: document.getElementById('subUsageText'),
                upgradeBtn: document.getElementById('upgradeBtn'),
                subNewChatBtn: document.getElementById('subNewChatBtn'),
                accountNameInfo: document.getElementById('accountNameInfo'),
                accountEmailInfo: document.getElementById('accountEmailInfo'),

                legalOverlay: document.getElementById('legalOverlay'),
                legalTitle: document.getElementById('legalTitle'),
                legalContent: document.getElementById('legalContent'),
                closeLegalBtn: document.getElementById('closeLegalBtn')
            };

            window.openLegalModal = function (title, htmlContent) {
                el.legalTitle.textContent = title;
                el.legalContent.innerHTML = htmlContent;
                el.legalOverlay.classList.add('active');
            };

            window.showAbout = function () {
                openLegalModal('Hakkımızda', `
                    <p style="margin-bottom: 15px;"><strong>Marul AI</strong>, 2024 yılında geliştirilmeye başlanan yerli ve milli, yenilikçi bir yapay zeka asistanıdır.</p>
                    <p style="margin-bottom: 15px;">Amacımız, doğal dil işleme teknolojilerini kullanarak Türkiye'deki ve dünyadaki kullanıcılara en hızlı, en güvenli ve akıllı çözümleri sunmaktır. Marul AI V7 modelimiz sayesinde Türkçe dil yapısını mükemmel anlar ve sizinle bir insan doğallığında sohbet eder.</p>
                    <p>Sürekli gelişen altyapımız ile programlama, içerik üretimi, dil çevirisi ve akademik araştırmalara kadar pek çok alanda size destek olmayı hedefliyoruz.</p>
                `);
            };

            window.showPrivacy = function () {
                openLegalModal('Gizlilik Politikası', `
                    <p style="margin-bottom: 15px;"><strong>1. Veri Toplama ve Kullanımı:</strong> Marul AI hizmetini kullanırken girdiğiniz sohbet mesajları, hizmet kalitesini artırmak ve modelimizi eğitmek amacıyla şifrelenerek saklanabilir. Hiçbir veriniz 3. taraflarla reklam amaçlı paylaşılmaz.</p>
                    <p style="margin-bottom: 15px;"><strong>2. Veri Güvenliği:</strong> Sunucularımızda saklanan tüm bilgiler yetkisiz erişimlere karşı sektör standartlarında şifrelenmiştir. Hesap şifreleriniz geri döndürülemez (hash) algoritmalarla korunmaktadır.</p>
                    <p style="margin-bottom: 15px;"><strong>3. Kullanıcı Hakları:</strong> Profilinize dilediğiniz an erişebilir, bilgilerinizi güncelleyebilir veya 'Hesabımı Sil' talebinde bulunabilirsiniz. Hesap silme işleminin ardından verileriniz anonimleştirilecektir.</p>
                    <p><strong>4. Çerez Politikası:</strong> Oturum bilgilerinizi güvende tutmak için tarayıcı üzerinde çerez ve SessionStorage/LocalStorage mantığı ile çalışmaktayız.</p>
                `);
            };

            window.showKVKK = function () {
                openLegalModal('KVKK Aydınlatma Metni', `
                    <p style="margin-bottom: 15px;"><strong>Kişisel Verilerin Korunması Kanunu Kapsamında Aydınlatma Metni</strong></p>
                    <p style="margin-bottom: 15px;">Marul AI olarak, 6698 sayılı Kişisel Verilerin Korunması Kanunu ("KVKK") uyarınca, "Veri Sorumlusu" sıfatıyla, kişisel verilerinizi Kanun’a uygun olarak işlemekteyiz.</p>
                    <p style="margin-bottom: 15px;"><strong>a. İşlenen Kişisel Verileriniz ve İşlenme Amaçları:</strong> Ad, soyad ve e-posta adresiniz, sistemde size profil oluşturmak ve yasal bir muhatap sağlamak amacıyla saklanmaktadır. Sohbet geçmişleriniz hizmet optimize işlemlerinde kullanım için kaydedilir.</p>
                    <p style="margin-bottom: 15px;"><strong>b. Kişisel Verilerin Aktarımı:</strong> Verileriniz yasal olarak yetkili kamu kurumları hariç, yurtiçinde veya yurtdışında hiçbir kişi ya da firmaya aktarılmamaktadır.</p>
                    <p style="margin-bottom: 15px;"><strong>c. KVKK Madde 11 Kapsamında Haklarınız:</strong> Kişisel verilerinizin işlenip işlenmediğini öğrenme, yanlış ise düzeltilmesini isteme, kanunda öngörülen şartlar çerçevesinde silinmesini talep etme haklarına sahipsiniz.</p>
                    <p>Başvurularınızı <strong>marulai.resmi@gmail.com</strong> adresi üzerinden yazılı olarak iletebilirsiniz.</p>
                `);
            };

            window.showTerms = function () {
                openLegalModal('Kullanıcı Sözleşmesi', `
                    <p style="margin-bottom: 15px;"><strong>1. Taraflar ve Onay:</strong> Bu sözleşme, Marul AI hizmetlerini kullanan her birey (Kullanıcı) ile platform yönetimi arasında elektronik ortamda onaylanmıştır.</p>
                    <p style="margin-bottom: 15px;"><strong>2. Hizmet Kullanım Şartları:</strong> Marul AI, genel bilgi verme amaçlı bir yapay zekadır. Hatalı, eksik veya yanıltıcı bilgi sunabileceği haller mevcuttur. Tıbbi, yasal, finansal konularda verilen tavsiyelerin sorumluluğu kullanıcıya aittir.</p>
                    <p style="margin-bottom: 15px;"><strong>3. Yasaklı Aktiviteler:</strong> Sistemi zorlamak, spam yapmak, güvenlik açıklarını istismar etmek yasaktır. Tespiti halinde hesaba erişim kalıcı olarak kesilir.</p>
                    <p><strong>4. Değişiklik Hakları:</strong> Marul AI, sistem altyapısında ve kullanım sözleşmesinde kullanıcılara bildirim yapmak şartıyla değişiklik yapma hakkını saklı tutar.</p>
                `);
            };

            window.showContact = function () {
                openLegalModal('İletişim Bilgileri', `
                    <p style="margin-bottom: 20px;">Marul AI platformuyla ilgili her türlü soru, görüş, öneri veya teknik destek talebi için bizimle iletişime geçebilirsiniz.</p>
                    <div style="background: var(--bg-card); padding: 20px; border-radius: var(--radius-md); text-align: center; border: 1px solid var(--border-light);">
                        <i class="fas fa-envelope" style="font-size: 2rem; color: var(--primary); margin-bottom: 15px;"></i>
                        <h4 style="margin-bottom: 10px; color: var(--text-main);">E-Posta Adresimiz</h4>
                        <a href="mailto:marulai.resmi@gmail.com" style="color: var(--primary); font-size: 1.1rem; font-weight: 600; text-decoration: none;">marulai.resmi@gmail.com</a>
                    </div>
                    <p style="margin-top: 20px; font-size: 0.9rem;">Destek taleplerinize en geç 48 iş saati içerisinde dönüş yapılacaktır.</p>
                `);
            };

            function showNotif(msg, type = 'info') {
                const notif = document.getElementById('notification');
                const map = { success: 'check-circle', error: 'exclamation-triangle', info: 'info-circle' };
                notif.className = `notification show ${type}`;
                notif.innerHTML = `<i class="fas fa-${map[type]}"></i> <span>${escapeHTML(msg)}</span>`;
                setTimeout(() => { notif.classList.remove('show'); }, 3000);
            }

            function escapeHTML(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.innerText = str;
                return div.innerHTML;
            }

            window.copyToClipboard = function (textToCopy, btn) {
                navigator.clipboard.writeText(decodeURIComponent(textToCopy)).then(() => {
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> Kopyalandı';
                    btn.style.color = '#00ff9d';
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.style.color = '';
                    }, 2000);
                }).catch(() => {
                    showNotif('Kopyalama başarısız', 'error');
                });
            };

            function addCodeActions(container) {
                container.querySelectorAll('pre').forEach(pre => {
                    const codeEl = pre.querySelector('code');
                    if (!codeEl) return;
                    const codeText = encodeURIComponent(codeEl.innerText);
                    const lang = codeEl.className.replace('language-', '') || 'code';

                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-block-wrapper';
                    pre.parentNode.insertBefore(wrapper, pre);

                    const header = document.createElement('div');
                    header.className = 'code-header';

                    const langLabel = document.createElement('div');
                    langLabel.className = 'code-lang';
                    langLabel.textContent = lang;
                    header.appendChild(langLabel);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'code-actions';

                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-btn';
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i> Kopyala';
                    copyBtn.onclick = () => copyToClipboard(codeText, copyBtn);
                    actionsDiv.appendChild(copyBtn);

                    header.appendChild(actionsDiv);
                    wrapper.appendChild(header);
                    wrapper.appendChild(pre);
                });
            }

            async function safeFetch(endpoint, options = {}) {
                const headers = { 'Content-Type': 'application/json', ...options.headers };
                if (__token) headers['Authorization'] = `Bearer ${__token}`;

                try {
                    const res = await fetch(`${CONFIG.BACKEND_URL}${endpoint}`, { ...options, headers });
                    const json = await res.json().catch(() => ({}));
                    return { ok: res.ok, status: res.status, data: json };
                } catch (err) {
                    return { ok: false, status: 500, data: { error: 'Ağ bağlantısı hatası.' } };
                }
            }

            function updateAccountUI() {
                if (__user) {
                    el.userCardBtn.style.display = 'flex';
                    if (el.sidebarAuthBtns) el.sidebarAuthBtns.style.display = 'none';
                    el.userNameTxt.textContent = __user.name;
                    el.userStatusTxt.textContent = state.isPremium ? 'Premium Üye' : 'Ücretsiz Üye';
                    el.userAvatar.textContent = __user.name.charAt(0).toUpperCase();
                    el.userStatusTxt.className = state.isPremium ? 'user-status premium' : 'user-status free';
                    el.logoutBtn.style.display = 'block';
                    el.settingsBtn.style.display = 'block';
                    el.subBtn.style.display = 'block';
                } else {
                    el.userCardBtn.style.display = 'flex';
                    if (el.sidebarAuthBtns) el.sidebarAuthBtns.style.display = 'flex';
                    el.userNameTxt.textContent = 'Misafir Kullanıcı';
                    el.userStatusTxt.textContent = `${state.guestQuestionsLeft} Hak Kaldı`;
                    el.userAvatar.textContent = 'M';
                    el.userStatusTxt.className = 'user-status free';
                    el.logoutBtn.style.display = 'none';
                    el.settingsBtn.style.display = 'none';
                    el.subBtn.style.display = 'none';
                }
                renderSidebarChats();
            }

            function toggleSidebar() {
                if (window.innerWidth <= 768) {
                    const isOpen = el.sidebar.classList.contains('mobile-open');
                    el.sidebar.classList.toggle('mobile-open');
                    el.closeSidebarBtn.style.display = isOpen ? 'none' : 'block';
                } else {
                    el.sidebar.classList.toggle('collapsed');
                }
            }

            function scrollToBottom() {
                requestAnimationFrame(() => {
                    el.msgContainer.scrollTop = el.msgContainer.scrollHeight;
                });
            }


            async function initApp() {
                updateAccountUI();
                if (__token) {
                    const check = await safeFetch('/verify-session');
                    if (check.ok && check.data.valid) {
                        state.isPremium = check.data.isPremium;
                        updateAccountUI();
                        await loadRemoteChats();
                    } else {
                        logout();
                    }
                } else {
                    if (state.guestChats.length === 0) createLocalChat();
                    else openChat(state.guestChats[0].id);
                }
            }

            async function loadRemoteChats() {
                const res = await safeFetch('/chats');
                if (res.ok) {
                    state.chats = res.data;
                    renderSidebarChats();
                    if (state.chats.length > 0) openChat(state.chats[0].id);
                    else createRemoteChat();
                }
            }

            function createLocalChat() {
                const nc = { id: 'g_' + Date.now(), title: 'Yeni Sohbet', messages: [], updated_at: new Date() };
                state.guestChats.unshift(nc);
                localStorage.setItem('g_chats', JSON.stringify(state.guestChats));
                openChat(nc.id);
            }

            async function createRemoteChat() {
                const res = await safeFetch('/chats', { method: 'POST' });
                if (res.ok) {
                    state.chats.unshift(res.data);
                    openChat(res.data.id);
                } else {
                    showNotif(res.data.error || 'Sohbet oluşturulamadı', 'error');
                }
            }

            function renderSidebarChats() {
                el.chatList.innerHTML = '';
                const list = state.isGuest ? state.guestChats : state.chats;
                list.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));

                const formatChatDate = (dateString) => {
                    if (!dateString) return '';
                    const d = new Date(dateString);
                    if (isNaN(d.getTime())) return '';
                    const months = ['Oca', 'Şub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Ağu', 'Eyl', 'Eki', 'Kas', 'Ara'];
                    const day = d.getDate();
                    const month = months[d.getMonth()];
                    const hours = d.getHours().toString().padStart(2, '0');
                    const mins = d.getMinutes().toString().padStart(2, '0');
                    return `${day} ${month} ${hours}:${mins}`;
                };

                list.forEach(c => {
                    const item = document.createElement('div');
                    item.className = `history-item ${c.id === state.currentChatId ? 'active' : ''}`;
                    const dateFormatted = formatChatDate(c.updated_at);

                    item.innerHTML = `
                    <div class="history-info">
                        <div class="history-title">${escapeHTML(c.title)}</div>
                        <div class="history-date">${dateFormatted}</div>
                    </div>
                    <div class="history-actions">
                        <button title="Sil" data-id="${c.id}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                    item.onclick = (e) => {
                        if (e.target.closest('button')) deleteChat(c.id);
                        else { openChat(c.id); if (window.innerWidth <= 768) toggleSidebar(); }
                    };
                    el.chatList.appendChild(item);
                });
            }

            async function deleteChat(id) {
                if (!confirm('Bu sohbeti silmek istediğinize emin misiniz?')) return;
                if (state.isGuest) {
                    state.guestChats = state.guestChats.filter(x => x.id !== id);
                    localStorage.setItem('g_chats', JSON.stringify(state.guestChats));
                    if (state.currentChatId === id) { state.guestChats.length ? openChat(state.guestChats[0].id) : createLocalChat(); }
                    else renderSidebarChats();
                } else {
                    await safeFetch(`/chats/${id}`, { method: 'DELETE' });
                    state.chats = state.chats.filter(x => x.id !== id);
                    if (state.currentChatId === id) { state.chats.length ? openChat(state.chats[0].id) : createRemoteChat(); }
                    else renderSidebarChats();
                }
            }

            async function openChat(id) {
                state.currentChatId = id;
                const chat = (state.isGuest ? state.guestChats : state.chats).find(x => x.id === id);
                el.chatTitleTxt.textContent = chat ? chat.title : 'Sohbet';

                el.msgInput.disabled = false;
                el.sendBtn.disabled = false;
                el.msgInput.placeholder = 'Marul AI ile mesajlaşın...';
                el.subNewChatBtn.style.display = 'none';

                Array.from(el.msgContainer.children).forEach(c => {
                    if (c.id !== 'welcomeScreen' && c.id !== 'typingInd') c.remove();
                });
                el.welcomeScreen.style.display = 'flex';
                renderSidebarChats();

                if (state.isGuest) {
                    if (chat && chat.messages.length) {
                        el.welcomeScreen.style.display = 'none';
                        chat.messages.forEach(m => appendHtmlMsg(m.role, m.content));

                        const userMsgs = chat.messages.filter(m => m.role === 'user').length;
                        if (userMsgs >= 25 && state.guestQuestionsLeft <= 0) {
                            el.subNewChatBtn.style.display = 'block';
                            el.msgInput.disabled = true;
                            el.sendBtn.disabled = true;
                            el.msgInput.placeholder = 'Misafir mesaj limitiniz doldu.';
                        }
                    }
                } else {
                    const res = await safeFetch(`/chats/${id}/messages`);
                    if (res.ok && res.data.length) {
                        el.welcomeScreen.style.display = 'none';
                        res.data.forEach(m => appendHtmlMsg(m.role === 'user' ? 'user' : 'ai', m.content));

                        const subRes = await safeFetch(`/subscription?chatId=${id}`);
                        if (subRes.ok && !subRes.data.isSubscribed && !state.isPremium) {
                            const count = subRes.data.messageCount;
                            const limit = subRes.data.limit;
                            if (count >= limit) {
                                el.subNewChatBtn.style.display = 'block';
                                el.msgInput.disabled = true;
                                el.sendBtn.disabled = true;
                                el.msgInput.placeholder = 'Bu sohbetteki mesaj limitiniz doldu.';
                            }
                        }
                    }
                }
            }

            function appendHtmlMsg(role, text) {
                el.welcomeScreen.style.display = 'none';
                const div = document.createElement('div');
                div.className = `message ${role}`;

                if (role === 'ai') {
                    const html = marked.parse(text);
                    div.innerHTML = `<div class="message-avatar"><img src="favicon.png"></div>
                                 <div class="message-content">
                                    <div class="markdown-body">${html}</div>
                                 </div>`;
                    addCodeActions(div);
                    div.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
                } else {
                    const initial = __user ? __user.name.charAt(0).toUpperCase() : 'M';
                    div.innerHTML = `<div class="message-content">${escapeHTML(text).replace(/\n/g, '<br>')}</div>
                                 <div class="message-avatar">${initial}</div>`;
                }

                el.msgContainer.insertBefore(div, el.typingInd);
                scrollToBottom();
            }

            async function handleSend() {
                const text = el.msgInput.value.trim();
                if (!text) return;

                if (state.isGuest && state.guestQuestionsLeft <= 0) {
                    showNotif('Misafir mesaj limitiniz doldu. Lütfen giriş yapın.', 'error');
                    el.authOverlay.classList.add('active');
                    el.loginForm.style.display = 'block';
                    el.registerForm.style.display = 'none';
                    setTimeout(() => initTurnstile('login'), 150);
                    return;
                }

                el.msgInput.value = '';
                el.msgInput.style.height = 'auto';
                el.sendBtn.disabled = true;
                appendHtmlMsg('user', text);
                el.typingInd.style.display = 'block';
                scrollToBottom();

                if (state.isGuest) {
                    state.guestQuestionsLeft--;
                    localStorage.setItem('guest_left', state.guestQuestionsLeft);
                    updateAccountUI();

                    const chat = state.guestChats.find(x => x.id === state.currentChatId);
                    let ctx = "";
                    if (chat) {
                        chat.messages.slice(-6).forEach(m => ctx += `${m.role}: ${m.content}\n`);
                        chat.messages.push({ role: 'user', content: text });
                        if (chat.title === 'Yeni Sohbet') chat.title = text.substring(0, 30);
                        chat.updated_at = new Date();
                        localStorage.setItem('g_chats', JSON.stringify(state.guestChats));
                    }
                    renderSidebarChats();

                    const res = await safeFetch('/guest-chat', {
                        method: 'POST',
                        body: JSON.stringify({ message: (ctx + text), model: state.selectedModel })
                    });

                    el.typingInd.style.display = 'none';
                    if (res.ok) {
                        appendHtmlMsg('ai', res.data.response);
                        chat.messages.push({ role: 'ai', content: res.data.response });
                        localStorage.setItem('g_chats', JSON.stringify(state.guestChats));
                    } else {
                        appendHtmlMsg('ai', 'Hata: ' + (res.data.error || 'Bağlantı sorunu'));
                    }
                } else {
                    const res = await safeFetch('/chat', {
                        method: 'POST',
                        body: JSON.stringify({ chatId: state.currentChatId, message: text, model: state.selectedModel })
                    });

                    el.typingInd.style.display = 'none';
                    if (res.ok) {
                        appendHtmlMsg('ai', res.data.response);
                        if (res.data.isNewChat) {
                            state.currentChatId = res.data.chatId;
                            loadRemoteChats();
                        }
                    } else {
                        if (res.data.error === 'MESSAGE_LIMIT_REACHED') {
                            showNotif('Sınıra ulaştınız. Devam etmek için premium paket edinin.', 'error');
                            el.msgInput.disabled = true;
                            el.sendBtn.disabled = true;
                            el.msgInput.placeholder = 'Bu sohbetteki mesaj limitiniz doldu.';
                            setTimeout(() => {
                                el.subBtn.click();
                            }, 500);
                        }
                        else appendHtmlMsg('ai', 'Hata: ' + (res.data.error || 'Bağlantı sorunu'));
                    }
                }
                el.sendBtn.disabled = false;
            }

            function initTurnstile(type) {
                if (!window.turnstile) {
                    setTimeout(() => initTurnstile(type), 100);
                    return;
                }

                if (state.turnstileWidgetId) window.turnstile.remove(state.turnstileWidgetId);
                const containerEl = document.getElementById(type === 'login' ? 'turnstileWrapLogin' : 'turnstileWrapReg');
                document.getElementById('turnstileWrapLogin').innerHTML = '';
                document.getElementById('turnstileWrapReg').innerHTML = '';

                state.tsToken = null;
                state.turnstileWidgetId = window.turnstile.render(containerEl, {
                    sitekey: CONFIG.TURNSTILE_SITE_KEY,
                    theme: 'dark',
                    callback: (t) => { state.tsToken = t; }
                });
            }

            async function handleLogin(e) {
                e.preventDefault();
                if (!state.tsToken) { showNotif("Güvenlik doğrulamasını tamamlayın", "error"); return; }

                const email = document.getElementById('loginEmail').value;
                const pass = document.getElementById('loginPass').value;
                const btn = document.getElementById('loginSubBtn');
                btn.disabled = true; btn.textContent = 'Bekleyin...';

                const res = await safeFetch('/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password: pass, turnstileToken: state.tsToken })
                });

                btn.disabled = false; btn.textContent = 'Giriş Yap';

                if (res.ok) {
                    loginSuccess(res.data.token, res.data.user);
                } else {
                    showNotif(res.data.error || 'Giriş yapılamadı', 'error');
                    initTurnstile('login');
                }
            }

            async function handleRegister(e) {
                e.preventDefault();
                if (!state.tsToken) { showNotif("Güvenlik doğrulamasını tamamlayın", "error"); return; }

                const name = document.getElementById('regName').value;
                const email = document.getElementById('regEmail').value;
                const pass = document.getElementById('regPass').value;
                const btn = document.getElementById('regSubBtn');
                btn.disabled = true; btn.textContent = 'Bekleyin...';

                const res = await safeFetch('/register', {
                    method: 'POST',
                    body: JSON.stringify({ name, email, password: pass, turnstileToken: state.tsToken })
                });

                btn.disabled = false; btn.textContent = 'Hesap Oluştur';

                if (res.ok) {
                    loginSuccess(res.data.token, res.data.user);
                } else {
                    showNotif(res.data.error || 'Kayıt başarısız', 'error');
                    initTurnstile('register');
                }
            }

            function loginSuccess(token, user) {
                __token = token;
                __user = user;
                state.isGuest = false;
                localStorage.setItem(STORAGE_KEY, token);
                localStorage.setItem(DATA_KEY, JSON.stringify(user));

                el.authOverlay.classList.remove('active');
                showNotif('Hoşgeldiniz!', 'success');
                initApp();
            }

            function logout() {
                __token = null; __user = null; state.isGuest = true;
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(DATA_KEY);
                sessionStorage.removeItem(STORAGE_KEY);
                sessionStorage.removeItem(DATA_KEY);
                window.location.reload();
            }

            el.msgInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight < 150 ? this.scrollHeight : 150) + 'px';
                el.sendBtn.disabled = this.value.trim().length === 0;
            });

            el.msgInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!el.sendBtn.disabled) handleSend();
                }
            });

            el.sendBtn.onclick = handleSend;
            el.newChatBtn.onclick = () => { state.isGuest ? createLocalChat() : createRemoteChat(); };
            el.subNewChatBtn.onclick = () => {
                el.subOverlay.classList.remove('active');
                state.isGuest ? createLocalChat() : createRemoteChat();
            };
            el.menuToggleBtn.onclick = toggleSidebar;
            el.closeSidebarBtn.onclick = toggleSidebar;
            el.logoutBtn.onclick = logout;

            el.modelBtn.onclick = (e) => {
                e.stopPropagation();
                el.modelSelector.classList.toggle('open');
            };

            document.querySelectorAll('.model-option').forEach(opt => {
                opt.onclick = () => {
                    state.selectedModel = opt.dataset.model;
                    el.selectedModelTxt.textContent = opt.querySelector('.model-op-name').textContent;
                    document.querySelectorAll('.model-option').forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                    el.modelSelector.classList.remove('open');
                };
            });

            document.onclick = (e) => {
                if (!el.modelSelector.contains(e.target)) el.modelSelector.classList.remove('open');
            };

            el.userCardBtn.onclick = () => {
                if (state.isGuest) {
                    el.authOverlay.classList.add('active');
                    el.loginForm.style.display = 'block';
                    el.registerForm.style.display = 'none';
                    setTimeout(() => initTurnstile('login'), 150);
                } else {
                    el.subBtn.click();
                }
            };

            el.closeAuthBtn.onclick = () => el.authOverlay.classList.remove('active');

            document.getElementById('switchToRegLink').onclick = (e) => {
                e.preventDefault();
                el.loginForm.style.display = 'none';
                el.registerForm.style.display = 'block';
                setTimeout(() => initTurnstile('register'), 150);
            };

            document.getElementById('switchToLoginLink').onclick = (e) => {
                e.preventDefault();
                el.registerForm.style.display = 'none';
                el.loginForm.style.display = 'block';
                setTimeout(() => initTurnstile('login'), 150);
            };

            el.sidebarLoginBtn.onclick = () => {
                if (window.innerWidth <= 768) toggleSidebar();
                el.authOverlay.classList.add('active');
                el.loginForm.style.display = 'block';
                el.registerForm.style.display = 'none';
                setTimeout(() => initTurnstile('login'), 150);
            };

            el.closeLegalBtn.onclick = () => el.legalOverlay.classList.remove('active');

            el.settingsBtn.onclick = async (e) => {
                e.stopPropagation();
                if (window.innerWidth <= 768) toggleSidebar();
                el.settingsOverlay.classList.add('active');
                el.sysPromptInput.value = 'Yükleniyor...';
                const sysPromptCount = document.getElementById('sysPromptCount');
                sysPromptCount.textContent = `... / 600`;
                const res = await safeFetch('/personalization');
                el.sysPromptInput.value = res.ok ? res.data.systemPrompt : '';
                sysPromptCount.textContent = `${el.sysPromptInput.value.length} / 600`;
            };
            el.closeSettingsBtn.onclick = () => el.settingsOverlay.classList.remove('active');

            el.sysPromptInput.addEventListener('input', (e) => {
                const sysPromptCount = document.getElementById('sysPromptCount');
                sysPromptCount.textContent = `${e.target.value.length} / 600`;
            });

            document.querySelectorAll('.personalization-example-item').forEach(item => {
                item.onclick = () => {
                    const txt = item.getAttribute('data-text');
                    if (el.sysPromptInput.value) {
                        el.sysPromptInput.value += ' ' + txt;
                    } else {
                        el.sysPromptInput.value = txt;
                    }
                    if (el.sysPromptInput.value.length > 600) {
                        el.sysPromptInput.value = el.sysPromptInput.value.substring(0, 600);
                    }
                    const sysPromptCount = document.getElementById('sysPromptCount');
                    sysPromptCount.textContent = `${el.sysPromptInput.value.length} / 600`;
                };
            });

            document.getElementById('clearSettingsBtn').onclick = () => {
                el.sysPromptInput.value = '';
                const sysPromptCount = document.getElementById('sysPromptCount');
                sysPromptCount.textContent = `0 / 600`;
            };

            el.settingsForm.onsubmit = async (e) => {
                e.preventDefault();
                el.saveSettingsBtn.disabled = true;
                el.saveSettingsBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Kaydediliyor...';
                const txt = el.sysPromptInput.value;
                const res = await safeFetch('/personalization', { method: 'POST', body: JSON.stringify({ systemPrompt: txt }) });
                if (res.ok) showNotif('Kişiselleştirme ayarları kaydedildi.', 'success');
                else showNotif('Kaydedilemedi: ' + (res.data.error || 'Bilinmeyen hata'), 'error');
                el.saveSettingsBtn.disabled = false;
                el.saveSettingsBtn.innerHTML = '<i class="fas fa-save"></i> Kaydet';
                el.settingsOverlay.classList.remove('active');
            };

            el.subBtn.onclick = async (e) => {
                e.stopPropagation();
                if (window.innerWidth <= 768) toggleSidebar();
                el.subOverlay.classList.add('active');
                el.subDetails.textContent = 'Abonelik bilgileri yükleniyor...';
                el.accountNameInfo.textContent = __user ? __user.name : '-';
                el.accountEmailInfo.textContent = __user ? __user.email : '-';

                const res = await safeFetch(`/subscription?chatId=${state.currentChatId}`);
                if (res.ok) {
                    const data = res.data;
                    const isPlus = data.isSubscribed || state.isPremium;
                    el.subPlanName.textContent = isPlus ? 'Premium Plan (Aktif)' : 'Ücretsiz Plan';
                    el.subPlanName.style.color = isPlus ? 'var(--primary)' : 'var(--text-main)';

                    if (isPlus) {
                        el.subDetails.textContent = 'Premium özelliklerin keyfini çıkarın! Sınırsız mesaj hakkına sahipsiniz.';
                        el.subProgressFill.style.width = '100%';
                        el.subProgressFill.style.background = 'var(--primary)';
                        el.subUsageText.textContent = 'Sınırsız Kullanım';
                        el.upgradeBtn.style.display = 'none';
                        el.subNewChatBtn.style.display = 'none';
                        el.msgInput.disabled = false;
                        el.msgInput.placeholder = 'Marul AI ile mesajlaşın...';
                    } else {
                        const used = data.messageCount || 0;
                        const limit = data.limit || 25;
                        const pct = Math.min((used / limit) * 100, 100);
                        el.subDetails.textContent = `Bu sohbette ${limit} mesaj hakkınız bulunmaktadır.`;
                        el.subProgressFill.style.width = pct + '%';
                        el.subProgressFill.style.background = pct >= 100 ? 'var(--danger)' : 'var(--primary)';
                        el.subUsageText.textContent = `${used} / ${limit} Mesaj Kullanıldı (Bu Sohbet)`;
                        el.upgradeBtn.style.display = 'block';
                        el.upgradeBtn.onclick = () => {
                            showNotif('Platformumuza mobil uygulamamız üzerinden devam edip özellikleri satın alabilirsiniz!', 'info');
                        };

                        if (pct >= 100) {
                            el.subNewChatBtn.style.display = 'block';
                            el.msgInput.disabled = true;
                            el.sendBtn.disabled = true;
                            el.msgInput.placeholder = 'Bu sohbetteki mesaj limitiniz doldu.';
                        } else {
                            el.subNewChatBtn.style.display = 'none';
                            el.msgInput.disabled = false;
                            el.msgInput.placeholder = 'Marul AI ile mesajlaşın...';
                        }
                    }
                } else {
                    el.subDetails.textContent = 'Abonelik durumu alınamadı.';
                }
            };
            el.closeSubBtn.onclick = () => el.subOverlay.classList.remove('active');

            el.loginForm.onsubmit = handleLogin;
            el.registerForm.onsubmit = handleRegister;

            function setAppHeight() {
                const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
                document.documentElement.style.setProperty('--app-height', vh + 'px');
            }

            setAppHeight();

            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    setAppHeight();
                    scrollToBottom();
                });
                window.visualViewport.addEventListener('scroll', setAppHeight);
            } else {
                window.addEventListener('resize', setAppHeight);
            }

            el.msgInput.addEventListener('focus', () => {
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        setAppHeight();
                        scrollToBottom();
                    }, 300);
                }
            });

            el.msgInput.addEventListener('blur', () => {
                if (window.innerWidth <= 768) {
                    setTimeout(setAppHeight, 100);
                }
            });

            initApp();

        })();
    </script>
</body>

</html>
